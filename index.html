<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Amalin App - Khodim Coding</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- CONFIG TEMA --- */
    :root {
      --primary-purple: #a855f7;
      --primary-green: #10b981;
      --genz-gradient: linear-gradient(135deg, #9333ea 0%, #d8b4fe 100%);
      --bg-dark: #020617;
      --card-bg: rgba(30, 27, 75, 0.75);
      --text-main: #f8fafc;
      --text-dim: #94a3b8;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    /* PENTING: Fix SweetAlert tertutup layer lain */
    .swal2-container {
        z-index: 10000 !important;
    }

    ::-webkit-scrollbar { width: 0px; background: transparent; }

    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.25rem;
      box-shadow: 0 4px 20px -5px rgba(0,0,0,0.3);
    }

    .app-card { border-radius: 1.25rem; padding: 1rem; transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
    .gradient-text { background: var(--genz-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }

    .habit-item {
      display: flex; align-items: center; padding: 1rem; border-radius: 1rem; background: #1e1b4b;
      margin-bottom: 0.75rem; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; cursor: pointer; min-height: 60px;
    }
    .habit-item:active { transform: scale(0.98); background: rgba(30, 27, 75, 0.9); }
    .habit-item.completed { background: #064e3b; border-color: var(--primary-green); }

    .bottom-nav {
      position: fixed; bottom: 1.25rem; left: 1rem; right: 1rem; max-width: 480px; margin: 0 auto;
      background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-radius: 1.5rem; display: flex; justify-content: space-around; align-items: center;
      padding: 0.75rem 0.5rem; z-index: 1000; border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px -5px rgba(0,0,0,0.5);
    }

    .nav-btn { color: #64748b; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.65rem; font-weight: 600; flex: 1; transition: all 0.2s; padding: 4px 0; }
    .nav-btn.active { color: var(--primary-purple); transform: translateY(-2px); }
    .nav-btn svg { width: 22px; height: 22px; }

    .section { display: none; padding-bottom: 7rem; }
    .section.active { display: block; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .progress-table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 1rem; background: #0f172a; padding-bottom: 5px; }
    .progress-table { width: 100%; min-width: 380px; border-collapse: collapse; table-layout: fixed; }
    .progress-table th { padding: 0.8rem 0.25rem; font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid rgba(255, 255, 255, 0.05); text-align: center; font-weight: 700; }
    .progress-table td { padding: 0.7rem 0.25rem; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.03); }

    .check-box { width: 26px; height: 26px; border-radius: 8px; border: 2px solid #334155; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .check-box.checked { background: var(--primary-green); border-color: var(--primary-green); color: white; }

    .card-select { background-color: #020617 !important; color: #ffffff !important; border: 2px solid var(--primary-purple) !important; font-weight: 700 !important; outline: none; padding: 0.75rem 1rem; border-radius: 1rem; appearance: none; text-align: center; width: 100%; font-size: 0.9rem; }
    .mini-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .stat-card { padding: 1rem; border-radius: 1.25rem; display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; }
    .stat-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: var(--text-dim); letter-spacing: 0.05em; }
    .stat-value { font-size: 1.25rem; font-weight: 800; color: #fff; line-height: 1.2; }

    .prayer-times-scroll { display: flex; justify-content: space-between; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; -webkit-overflow-scrolling: touch; }
    .prayer-time-item { flex: 1; min-width: 60px; text-align: center; padding: 0.5rem 0.25rem; border-radius: 0.75rem; background: rgba(255, 255, 255, 0.03); }
    .prayer-label { font-size: 0.55rem; font-weight: 700; text-transform: uppercase; color: var(--text-dim); margin-bottom: 2px; }
    .prayer-time { font-size: 0.8rem; font-weight: 800; color: #fff; }

    .mood-btn { font-size: 1.75rem; padding: 0.75rem; border-radius: 1rem; border: 2px solid transparent; transition: all 0.2s; cursor: pointer; background: rgba(255,255,255,0.03); }
    .mood-btn.active { background: rgba(168, 85, 247, 0.2); border-color: var(--primary-purple); transform: scale(1.05); }

    .mini-progress-bg { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin-top: 8px; }
    .mini-progress-bar { height: 100%; border-radius: 10px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    .planner-card { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); border-radius: 1.5rem; padding: 1.5rem; }
    .range-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 10px; background: rgba(255, 255, 255, 0.15); outline: none; margin: 1rem 0; }
    .range-slider::-webkit-slider-thumb { appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary-purple); cursor: pointer; box-shadow: 0 0 15px rgba(168, 85, 247, 0.6); transition: transform 0.1s; }
    .range-slider::-webkit-slider-thumb:active { transform: scale(1.2); }

    .input-field { background: #1e1b4b; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 1rem; font-size: 0.95rem; color: white; outline: none; width: 100%; transition: border-color 0.2s; }
    .input-field:focus { border-color: var(--primary-purple); }

    .btn-primary { background: var(--primary-purple); color: white; padding: 1rem; border-radius: 1rem; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; width: 100%; border: none; cursor: pointer; letter-spacing: 0.05em; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3); }
    .btn-primary:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(168, 85, 247, 0.2); }

    .profile-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-purple); }
    .report-log-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; text-align: center; }
    .report-tab-btn { transition: all 0.3s ease; border-radius: 0.75rem; color: #94a3b8; font-weight: 700; font-size: 0.75rem; }
    .report-tab-btn.active { background: var(--primary-purple); color: white !important; shadow: 0 2px 10px rgba(168,85,247,0.3); }
    .step-badge { width: 22px; height: 22px; border-radius: 50%; background: var(--primary-purple); color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 800; margin-right: 8px; flex-shrink: 0; }
    .deco-circle { position: absolute; z-index: -1; filter: blur(90px); border-radius: 50%; opacity: 0.15; pointer-events: none; }
    
    .juz-tile { background: #1e1b4b; border: 1px solid rgba(255,255,255,0.05); border-radius: 1rem; padding: 0.85rem; display: flex; align-items: center; gap: 0.85rem; transition: all 0.2s; cursor: pointer; min-height: 64px; }
    .juz-tile:active { transform: scale(0.97); background: rgba(30, 27, 75, 0.9); }
    .juz-checkbox { width: 28px; height: 28px; border-radius: 50%; border: 2.5px solid #475569; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
    .juz-tile.checked .juz-checkbox { background: var(--primary-green); border-color: var(--primary-green); color: white; }
    .juz-tile.checked .juz-text { color: white; font-weight: 700; }
    .juz-text { font-size: 0.85rem; color: #94a3b8; font-weight: 500; }

    .quran-tab-btn { position: relative; padding-bottom: 0.85rem; color: var(--text-dim); font-weight: 600; font-size: 0.75rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
    .quran-tab-btn.active { color: var(--primary-purple); font-weight: 800; }
    .quran-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 10%; width: 80%; height: 4px; background: var(--primary-purple); border-radius: 4px 4px 0 0; box-shadow: 0 -2px 10px var(--primary-purple); }

    .manual-select { background-color: #1e1b4b; color: white; border: 1px solid rgba(255,255,255,0.1); padding: 0.85rem 1rem; border-radius: 1rem; width: 100%; outline: none; font-size: 0.9rem; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
    .manual-select option { background-color: #020617; color: white; padding: 10px; }

    .dua-card-list { background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.25rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 4px 15px -3px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
    .dua-card-list::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: var(--primary-purple); border-radius: 4px 0 0 4px; }

    .adzan-toggle { width: 36px; height: 20px; background: #334155; border-radius: 20px; position: relative; cursor: pointer; transition: background 0.3s; }
    .adzan-toggle.active { background: var(--primary-purple); }
    .adzan-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .adzan-toggle.active::after { transform: translateX(16px); }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
    .modal-content { background: #1e1b4b; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 380px; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: scale(0.95); opacity: 0; transition: all 0.3s; }
    .modal-overlay.active .modal-content { transform: scale(1); opacity: 1; }

    .dua-tab-btn { position: relative; padding-bottom: 0.85rem; color: var(--text-dim); font-weight: 600; font-size: 0.75rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; flex: 1; text-align: center; }
    .dua-tab-btn.active { color: var(--primary-green); font-weight: 800; }
    .dua-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 15%; width: 70%; height: 4px; background: var(--primary-green); border-radius: 4px 4px 0 0; box-shadow: 0 -2px 10px var(--primary-green); }
  </style>
</head>
<body class="pb-32 text-white">

  <div class="deco-circle w-64 h-64 bg-purple-600 top-[-10%] left-[-10%]"></div>
  <div class="deco-circle w-80 h-80 bg-emerald-600 bottom-[5%] right-[-10%]"></div>

  <!-- SCREEN: AUTH -->
  <div id="auth-screen" class="fixed inset-0 z-[2000] bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
    <div class="w-full max-w-xs space-y-10">
      <div class="space-y-4">
        <div class="text-7xl animate-bounce mb-4">ğŸŒ™</div>
        <h1 class="text-5xl font-black tracking-tighter uppercase leading-none drop-shadow-2xl" style="font-family: 'Poppins', sans-serif;">
          <span class="text-white" style="-webkit-text-stroke: 8px var(--primary-purple); paint-order: stroke fill;">Amalin</span><span class="text-pink-500" style="-webkit-text-stroke: 8px white; paint-order: stroke fill;">App</span>
        </h1>
        <p class="text-slate-400 text-sm font-bold uppercase tracking-widest mt-6">Niatin, Jalanin, Konsisten</p>
      </div>

      <div id="form-login" class="space-y-5 w-full">
        <input type="email" id="login-email" class="input-field py-4 text-base" placeholder="Email Kamu">
        <div class="relative">
            <input type="password" id="login-pass" class="input-field py-4 text-base pr-12" placeholder="Password">
            <button type="button" onclick="togglePasswordVisibility('login-pass', this)" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white p-2">
                <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
        </div>
        <button onclick="doLogin()" class="btn-primary py-4 text-sm shadow-xl shadow-purple-900/20 active:scale-95 transition-all">MASUK SEKARANG</button>
        <div class="flex flex-col gap-3 mt-4">
            <!-- Fitur Lupa Password dihapus sesuai permintaan -->
            <button onclick="switchAuth('register')" class="text-xs font-black text-purple-400 uppercase tracking-widest p-2 hover:bg-white/5 rounded-lg transition-all">Daftar Akun Baru</button>
        </div>
      </div>

      <div id="form-register" class="hidden space-y-5 w-full">
        <input type="text" id="reg-name" class="input-field py-4" placeholder="Nama Panggilan">
        <input type="email" id="reg-email" class="input-field py-4" placeholder="Email">
        <div class="relative">
            <input type="password" id="reg-pass" class="input-field py-4 pr-12" placeholder="Password">
            <button type="button" onclick="togglePasswordVisibility('reg-pass', this)" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white p-2">
                <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
        </div>
        <button onclick="doRegister()" class="btn-primary py-4 active:scale-95 transition-all">DAFTAR SEKARANG</button>
        <button onclick="switchAuth('login')" class="text-xs font-bold text-slate-400 uppercase block w-full mt-4 p-2 hover:bg-white/5 rounded-lg">Sudah punya akun? Masuk</button>
      </div>
    </div>
  </div>

  <!-- MODAL NOTIFIKASI ADZAN -->
  <div id="modal-adzan-settings" class="modal-overlay">
      <div class="modal-content">
          <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-black text-white">Notifikasi Adzan</h3>
              <button onclick="toggleAdzanModal(false)" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
          </div>
          <div class="flex bg-slate-900/50 p-1 rounded-xl mb-6">
              <button onclick="switchAdzanTab('beep')" id="tab-adzan-beep" class="flex-1 py-2 text-xs font-bold rounded-lg text-white bg-purple-600 transition-all">Beep</button>
              <button onclick="switchAdzanTab('full')" id="tab-adzan-full" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">Adzan</button>
          </div>
          <div class="space-y-4" id="adzan-toggle-list"></div>
          <div class="mt-6 pt-4 border-t border-white/10 text-[10px] text-center text-slate-500">*Pastikan volume HP tidak di-silent agar suara terdengar.</div>
      </div>
  </div>

  <div id="main-app" class="hidden max-w-md mx-auto relative min-h-screen">
    <header class="p-6 pt-8 flex justify-between items-center relative z-40">
      <div class="space-y-1">
        <p class="text-[10px] font-black text-slate-500 uppercase tracking-wide" id="header-masehi-date">--:--</p>
        <p class="text-xs font-black text-emerald-500 uppercase tracking-wide" id="header-hijri-date">1 RAMADHAN 1447 H</p>
        <h2 id="greeting-text" class="text-2xl font-extrabold text-white leading-tight mt-1">Assalamu'alaikum, <br><span id="user-name-display" class="gradient-text text-3xl">Akhi</span></h2>
      </div>
      <div id="header-streak-badge" class="hidden">
          <div class="streak-pop"><i data-lucide="flame" class="w-4 h-4 fill-current"></i><span id="streak-count-header">0</span></div>
      </div>
    </header>

    <main class="px-6 pb-32">
        <!-- BERANDA -->
        <section id="tab-home" class="section active space-y-6">
            <div class="app-card bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 text-white relative overflow-hidden shadow-2xl shadow-purple-900/30 flex flex-col justify-between min-h-[200px]">
                <div class="relative z-10 flex justify-between items-start">
                    <div><p class="text-[10px] font-black uppercase opacity-70 mb-1 tracking-widest">Ramadhan Kariim</p><h3 id="card-hijri-display" class="text-2xl font-black italic tracking-tighter">1 RAMADHAN 1447 H</h3></div>
                    <div class="text-right"><p id="countdown-label" class="text-[9px] font-black uppercase opacity-70 mb-0.5 tracking-wide">DETEKSI...</p><p id="countdown-timer" class="text-lg font-black tracking-tighter tabular-nums">00:00:00</p></div>
                </div>
                <div class="relative z-10 my-4"><p id="daily-inspiration-text" class="inspiration-text italic text-sm font-medium leading-relaxed opacity-90">"Puasalah kalian agar kalian sehat."</p></div>
                <div class="relative z-10">
                    <select id="home-date-filter" class="input-field card-select py-3 text-sm font-bold shadow-lg" onchange="changeActiveDay(this.value)"></select>
                </div>
                <i data-lucide="moon-star" class="absolute right-[-20px] bottom-[-20px] opacity-10 rotate-12 w-32 h-32"></i>
            </div>

            <!-- JADWAL SHOLAT -->
            <div class="glass-card p-5 space-y-4">
                <div class="flex justify-between items-center border-b border-white/10 pb-3 mb-1">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2"><div class="p-1.5 bg-purple-500/20 rounded-lg"><i data-lucide="map-pin" class="w-3.5 h-3.5 text-purple-400"></i></div><span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Jadwal Sholat</span></div>
                        <span id="current-location-display" class="text-[9px] font-bold text-purple-300 uppercase truncate max-w-[180px] mt-1 ml-1">Mendeteksi Lokasi...</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- BUTTON LONCENG UPDATE: Open Modal -->
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 border border-white/5 active:bg-slate-700 cursor-pointer" onclick="toggleAdzanModal(true)">
                            <i id="main-bell-icon" data-lucide="bell" class="w-4 h-4 transition-colors text-slate-400"></i>
                        </div>
                        <div id="btn-refresh-location" onclick="detectLocation()" class="cursor-pointer w-8 h-8 flex items-center justify-center bg-purple-600/20 rounded-full border border-purple-500/30 active:scale-90 transition-transform"><i data-lucide="refresh-cw" class="w-3.5 h-3.5 text-purple-400"></i></div>
                    </div>
                </div>
                <div class="prayer-times-scroll">
                    <div class="prayer-time-item"><p class="prayer-label">Subuh</p><p class="prayer-time" id="time-fajr">--:--</p></div>
                    <div class="prayer-time-item"><p class="prayer-label">Dzhur</p><p class="prayer-time" id="time-dhuhr-val">--:--</p></div>
                    <div class="prayer-time-item"><p class="prayer-label">Ashar</p><p class="prayer-time" id="time-asr">--:--</p></div>
                    <div class="prayer-time-item"><p class="prayer-label">Mghrb</p><p class="prayer-time" id="time-maghrib">--:--</p></div>
                    <div class="prayer-time-item"><p class="prayer-label">Isya</p><p class="prayer-time" id="time-isha">--:--</p></div>
                </div>
            </div>

            <div class="mini-card-grid">
                <div class="stat-card glass-card border-b-4 border-emerald-500"><p class="stat-label">Wajib</p><span class="stat-value" id="stat-wajib">0/5</span><div class="mini-progress-bg"><div id="bar-wajib" class="mini-progress-bar bg-emerald-500" style="width: 0%"></div></div></div>
                <div class="stat-card glass-card border-b-4 border-amber-400"><p class="stat-label">Sunnah</p><span class="stat-value" id="stat-sunnah">0/8</span><div class="mini-progress-bg"><div id="bar-sunnah" class="mini-progress-bar bg-amber-400" style="width: 0%"></div></div></div>
                <div class="stat-card glass-card border-b-4 border-purple-500"><p class="stat-label">Challenger</p><span class="stat-value" id="stat-challenger">0/6</span><div class="mini-progress-bg"><div id="bar-challenger" class="mini-progress-bar bg-purple-500" style="width: 0%"></div></div></div>
                <div class="stat-card glass-card border-b-4 border-blue-400"><p class="stat-label">Khatam</p><span class="stat-value" id="stat-khatam">0/604</span><div class="mini-progress-bg"><div id="bar-khatam" class="mini-progress-bar bg-blue-500" style="width: 0%"></div></div></div>
            </div>

            <div id="habit-container" class="space-y-4 pb-4"></div>
        </section>

        <!-- TAB: QURAN PLANNER -->
        <section id="tab-progress" class="section space-y-6">
            <h3 class="text-3xl font-black uppercase text-white leading-none pl-2">Quran<br><span class="gradient-text">Planner</span></h3>
            
            <!-- QURAN TAB NAVIGATION -->
            <div class="flex border-b border-white/10 mb-4 px-2 overflow-x-auto no-scrollbar">
                <button id="btn-quran-juz" onclick="switchQuranTab('juz')" class="quran-tab-btn active flex-1 min-w-[90px]">1 Day 1 Juz</button>
                <button id="btn-quran-page" onclick="switchQuranTab('page')" class="quran-tab-btn flex-1 min-w-[90px]">2 Lembar</button>
                <button id="btn-quran-manual" onclick="switchQuranTab('manual')" class="quran-tab-btn flex-1 min-w-[90px]">Manual</button>
            </div>

            <!-- VIEW 1: JUZ TRACKER -->
            <div id="view-quran-juz" class="space-y-5">
                <div class="glass-card p-6 relative overflow-hidden border border-white/10 shadow-xl">
                   <div class="flex justify-between items-end mb-4">
                      <div>
                         <div class="flex items-center gap-2 mb-2">
                             <div class="p-2 bg-purple-500/20 rounded-xl"><i data-lucide="bookmark" class="w-4 h-4 text-purple-400"></i></div>
                             <h4 class="text-sm font-black uppercase text-white tracking-tight">Progress Khatam</h4>
                         </div>
                         <p class="text-xs text-slate-400 font-bold uppercase tracking-widest pl-1"><span id="juz-completed-count" class="text-white">0</span> of 30 Juz</p>
                      </div>
                      <h2 class="text-4xl font-black gradient-text leading-none" id="juz-progress-percent">0%</h2>
                   </div>
                   <div class="bg-slate-800 h-3 rounded-full overflow-hidden border border-white/5">
                      <div id="juz-progress-bar" class="bg-gradient-to-r from-purple-500 to-emerald-400 h-full transition-all duration-700 shadow-[0_0_15px_rgba(168,85,247,0.5)]" style="width: 0%"></div>
                   </div>
                </div>

                <div class="flex justify-between items-center px-1 mb-2">
                    <h3 class="text-lg font-black uppercase text-white tracking-tighter">30 Juz Checklist</h3>
                    <button onclick="resetJuzProgress()" class="bg-red-500/10 text-red-400 p-2.5 rounded-xl border border-red-500/20 hover:bg-red-500 hover:text-white transition-all shadow-lg active:scale-95">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div id="juz-list-container" class="grid grid-cols-2 gap-3 pb-8"></div>
            </div>

            <!-- VIEW 2: PAGE TRACKER -->
            <div id="view-quran-page" class="hidden space-y-5">
                <div class="flex justify-between items-center px-1 mb-1">
                    <h3 class="text-lg font-black uppercase text-white tracking-tighter">Capaian Halaman</h3>
                    <button onclick="resetPageProgress()" class="bg-red-500/10 text-red-400 p-2.5 rounded-xl border border-red-500/20 hover:bg-red-500 hover:text-white transition-all shadow-lg active:scale-95">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="app-card glass-card relative overflow-hidden border border-white/10 p-6 text-center">
                    <div class="relative z-10 flex flex-col gap-6">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3"><div class="p-2 bg-emerald-500/20 rounded-xl"><i data-lucide="book-open" class="w-5 h-5 text-emerald-400"></i></div><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Total Progress</p></div>
                            <div class="bg-indigo-500/20 px-3 py-1.5 rounded-full border border-indigo-500/30"><p class="text-[9px] font-black text-indigo-300 uppercase" id="remaining-pages-label">SISA 604 Hal</p></div>
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="flex items-baseline gap-1"><h4 class="text-5xl font-black text-white tracking-tighter" id="total-page-count">0</h4><span class="text-sm font-black text-slate-500 uppercase ml-1">/ 604</span></div>
                            <span class="text-emerald-400 font-black text-3xl" id="total-page-percent">0%</span>
                        </div>
                        <div class="mini-progress-bg h-3 bg-slate-800 rounded-full overflow-hidden"><div id="total-page-bar" class="mini-progress-bar bg-gradient-to-r from-purple-500 to-emerald-400 h-full transition-all duration-1000" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="planner-card space-y-5">
                    <div class="flex justify-between items-center"><label class="text-[10px] font-black uppercase text-purple-300 tracking-widest">Target Khatam (Maks 10x)</label><span id="khatam-target-val" class="text-xl font-black italic text-white">1 Kali</span></div>
                    <input type="range" id="khatam-range" min="1" max="10" step="1" value="1" class="range-slider" oninput="handleQuranPlannerSlider(this.value)">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-black/30 p-4 rounded-2xl"><p class="text-[9px] font-black text-slate-400 uppercase mb-1">Target Harian</p><p id="target-pages-day" class="text-lg font-black text-emerald-400">20 Halaman</p></div>
                        <div class="bg-black/30 p-4 rounded-2xl"><p class="text-[9px] font-black text-slate-400 uppercase mb-1">Per Sholat</p><p id="target-pages-prayer" class="text-lg font-black text-purple-400">4 Halaman</p></div>
                    </div>
                </div>

                <div class="progress-table-container no-scrollbar shadow-xl border border-white/5 pb-8">
                    <table class="progress-table text-white">
                      <thead><tr><th style="width:40px;">Tgl</th><th>Subuh</th><th>Dzhur</th><th>Ashar</th><th>Mghb</th><th>Isya</th></tr></thead>
                      <tbody id="progress-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-quran-manual" class="hidden space-y-6">
                <div class="flex justify-between items-center px-1">
                    <h3 class="text-lg font-black uppercase text-white tracking-tighter">Catatan Bacaan</h3>
                    <button onclick="resetManualLog()" class="bg-red-500/10 text-red-400 p-2.5 rounded-xl border border-red-500/20 hover:bg-red-500 hover:text-white transition-all shadow-lg active:scale-95">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="glass-card p-6 space-y-5 border border-white/10 shadow-lg">
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-bold text-slate-400 tracking-widest pl-1">Mulai Dari</label>
                        <div class="flex gap-3">
                            <select id="manual-surah-start" class="manual-select flex-[2] text-sm"></select>
                            <input type="number" id="manual-ayat-start" class="input-field flex-1 text-center font-bold" placeholder="Ayat">
                        </div>
                    </div>
                    
                    <div class="flex justify-center -my-2 text-slate-500"><i data-lucide="arrow-down" class="w-5 h-5"></i></div>

                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-bold text-slate-400 tracking-widest pl-1">Sampai Dengan</label>
                        <div class="flex gap-3">
                            <select id="manual-surah-end" class="manual-select flex-[2] text-sm"></select>
                            <input type="number" id="manual-ayat-end" class="input-field flex-1 text-center font-bold" placeholder="Ayat">
                        </div>
                    </div>

                    <button onclick="saveManualEntry()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 uppercase tracking-widest text-xs mt-2 flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Catatan
                    </button>
                </div>

                <div class="space-y-3 pb-8">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1 border-l-4 border-purple-500 ml-1 pl-3">Riwayat Bacaan</h4>
                    <div id="manual-log-list" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- TAB: DOA (UPDATED CARD STYLE) -->
        <section id="tab-duas" class="section space-y-6">
            <h3 class="text-3xl font-black uppercase text-white text-center mb-6">Doa <span class="gradient-text">Ramadhan</span></h3>
            
            <!-- DUA TAB NAVIGATION -->
            <div class="flex border-b border-white/10 mb-4 px-2 overflow-x-auto no-scrollbar">
                <button id="btn-dua-doa" onclick="switchDuaTab('doa')" class="dua-tab-btn active flex-1 min-w-[80px]">Doa Harian</button>
                <button id="btn-dua-niat" onclick="switchDuaTab('niat')" class="dua-tab-btn flex-1 min-w-[80px]">Niat Puasa</button>
                <button id="btn-dua-fiqih" onclick="switchDuaTab('fiqih')" class="dua-tab-btn flex-1 min-w-[80px]">Fiqih</button>
            </div>

            <!-- VIEW 1: DOA HARIAN -->
            <div id="view-dua-doa" class="space-y-6">
                <div id="dua-list-container" class="space-y-5 pb-8 overflow-y-auto max-h-[70vh] no-scrollbar px-1">
                    <!-- Doa List Generated by JS -->
                </div>
            </div>

            <!-- VIEW 2: NIAT (STATIC CONTENT) -->
            <div id="view-dua-niat" class="hidden space-y-5 px-1 pb-8">
                <!-- Niat Puasa -->
                <div class="dua-card-list space-y-4">
                    <p class="text-[9px] font-black uppercase text-emerald-400 tracking-widest mb-1 text-white">Niat Puasa Ramadhan</p>
                    <p class="text-xl font-serif text-right text-white leading-loose">Ù†ÙÙˆÙÙŠÙ’ØªÙ ØµÙÙˆÙ’Ù…Ù ØºÙØ¯Ù Ø¹ÙÙ†Ù’ Ø£ÙØ¯ÙØ§Ø¡Ù ÙÙØ±Ù’Ø¶Ù Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù Ù‡ÙØ°ÙÙ‡Ù Ø§Ù„Ø³ÙÙ‘Ù†ÙØ©Ù Ù„ÙÙ„Ù‘Ù°Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰</p>
                    <p class="text-xs italic text-slate-400">Nawaitu shauma ghadin 'an ada'i fardhi syahri Ramadhana hadzihis sanati lillahi ta'ala</p>
                    <p class="text-sm font-bold text-emerald-400 leading-snug">"Aku berniat puasa esok hari untuk menunaikan fardhu di bulan Ramadhan tahun ini, karena Allah Ta'ala."</p>
                </div>
                
                <!-- Niat Berbuka -->
                <div class="dua-card-list space-y-4">
                    <p class="text-[9px] font-black uppercase text-purple-400 tracking-widest mb-1 text-white">Doa Berbuka Puasa</p>
                    <p class="text-xl font-serif text-right text-white leading-loose">Ø°ÙÙ‡ÙØ¨Ù Ø§Ù„Ø¸ÙÙ‘Ù…ÙØ£Ù ÙˆÙØ§Ø¨Ù’ØªÙÙ„ÙÙ‘ØªÙ Ø§Ù„Ù’Ø¹ÙØ±ÙÙˆÙ‚ÙØŒ ÙˆÙØ«ÙØ¨ÙØªÙ Ø§Ù„Ø£ÙØ¬Ù’Ø±Ù Ø¥ÙÙ†Ù’ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„Ù‡Ù</p>
                    <p class="text-xs italic text-slate-400">Dzahabadzh dzhama-u wabtallatil-'uruqu wa tsabatal-ajru insyaa-Allah</p>
                    <p class="text-sm font-bold text-emerald-400 leading-snug">"Telah hilang rasa haus, dan urat-urat telah basah serta pahala telah tetap, insya Allah."</p>
                </div>

                <!-- Niat Zakat Fitrah Sendiri -->
                <div class="dua-card-list space-y-4">
                    <p class="text-[9px] font-black uppercase text-blue-400 tracking-widest mb-1 text-white">Niat Zakat Fitrah (Diri Sendiri)</p>
                    <p class="text-xl font-serif text-right text-white leading-loose">Ù†ÙÙˆÙÙŠÙ’ØªÙ Ø£ÙÙ†Ù’ Ø£ÙØ®Ù’Ø±ÙØ¬Ù Ø²ÙÙƒÙØ§Ø©Ù Ø§Ù„Ù’ÙÙØ·Ù’Ø±Ù Ø¹ÙÙ†Ù’ Ù†ÙÙÙ’Ø³ÙÙŠÙ’ ÙÙØ±Ù’Ø¶Ù‹Ø§ Ù„ÙÙ„Ù‘Ù°Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰</p>
                    <p class="text-xs italic text-slate-400">Nawaitu an ukhrija zakaatal fithri 'an nafsii fardhan lillaahi ta'alaa</p>
                    <p class="text-sm font-bold text-emerald-400 leading-snug">"Aku niat mengeluarkan zakat fitrah untuk diriku sendiri, fardhu karena Allah Ta'ala."</p>
                </div>

                 <!-- Niat Zakat Fitrah Istri -->
                <div class="dua-card-list space-y-4">
                    <p class="text-[9px] font-black uppercase text-blue-400 tracking-widest mb-1 text-white">Niat Zakat Fitrah (Untuk Istri)</p>
                    <p class="text-xl font-serif text-right text-white leading-loose">Ù†ÙÙˆÙÙŠÙ’ØªÙ Ø£ÙÙ†Ù’ Ø£ÙØ®Ù’Ø±ÙØ¬Ù Ø²ÙÙƒÙØ§Ø©Ù Ø§Ù„Ù’ÙÙØ·Ù’Ø±Ù Ø¹ÙÙ†Ù’ Ø²ÙÙˆÙ’Ø¬ÙØªÙÙŠÙ’ ÙÙØ±Ù’Ø¶Ù‹Ø§ Ù„ÙÙ„Ù‘Ù°Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰</p>
                    <p class="text-xs italic text-slate-400">Nawaitu an ukhrija zakaatal fithri 'an zaujatii fardhan lillaahi ta'alaa</p>
                    <p class="text-sm font-bold text-emerald-400 leading-snug">"Aku niat mengeluarkan zakat fitrah untuk istriku, fardhu karena Allah Ta'ala."</p>
                </div>

                 <!-- Niat Zakat Fitrah Keluarga -->
                 <div class="dua-card-list space-y-4">
                    <p class="text-[9px] font-black uppercase text-blue-400 tracking-widest mb-1 text-white">Niat Zakat Fitrah (Seluruh Keluarga)</p>
                    <p class="text-xl font-serif text-right text-white leading-loose">Ù†ÙÙˆÙÙŠÙ’ØªÙ Ø£ÙÙ†Ù’ Ø£ÙØ®Ù’Ø±ÙØ¬Ù Ø²ÙÙƒÙØ§Ø©Ù Ø§Ù„Ù’ÙÙØ·Ù’Ø±Ù Ø¹ÙÙ†ÙÙ‘ÙŠÙ’ ÙˆÙØ¹ÙÙ†Ù’ Ø¬ÙÙ…ÙÙŠÙ’Ø¹Ù Ù…ÙØ§ ÙŠÙÙ„Ù’Ø²ÙÙ…ÙÙ†ÙÙŠÙ’ Ù†ÙÙÙÙ‚ÙØ§ØªÙÙ‡ÙÙ…Ù’ Ø´ÙØ±Ù’Ø¹Ù‹Ø§ ÙÙØ±Ù’Ø¶Ù‹Ø§ Ù„ÙÙ„Ù‘Ù°Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰</p>
                    <p class="text-xs italic text-slate-400">Nawaitu an ukhrija zakaatal fithri 'annii wa 'an jamii'i maa yalzamunii nafaqatuhum syar'an fardhan lillaahi ta'alaa</p>
                    <p class="text-sm font-bold text-emerald-400 leading-snug">"Aku niat mengeluarkan zakat fitrah untuk diriku dan seluruh orang yang nafkahnya menjadi tanggunganku, fardhu karena Allah Ta'ala."</p>
                </div>
            </div>

            <!-- VIEW 3: FIQIH (STATIC CONTENT) -->
            <div id="view-dua-fiqih" class="hidden space-y-5 px-1 pb-8">
                <div class="glass-card p-5 space-y-3">
                    <h4 class="text-sm font-black uppercase text-purple-400 tracking-wide border-b border-white/10 pb-2">Rukun Puasa</h4>
                    <ul class="list-disc list-inside text-xs text-slate-300 space-y-2 leading-relaxed">
                        <li><strong class="text-white">Niat:</strong> Dilakukan pada malam hari sebelum terbit fajar (untuk puasa wajib).</li>
                        <li><strong class="text-white">Menahan Diri:</strong> Dari hal-hal yang membatalkan puasa (makan, minum, jimak) dari terbit fajar hingga terbenam matahari.</li>
                    </ul>
                </div>

                <div class="glass-card p-5 space-y-3">
                    <h4 class="text-sm font-black uppercase text-emerald-400 tracking-wide border-b border-white/10 pb-2">Amalan Sunnah Rasul</h4>
                    <ul class="list-disc list-inside text-xs text-slate-300 space-y-2 leading-relaxed">
                        <li>Mengakhirkan Sahur.</li>
                        <li>Menyegerakan Berbuka.</li>
                        <li>Berdoa saat berbuka.</li>
                        <li>Memberi makan orang yang berbuka (Iftishar).</li>
                        <li>Memperbanyak sedekah dan membaca Al-Quran.</li>
                        <li>I'tikaf di sepuluh hari terakhir.</li>
                    </ul>
                </div>

                <div class="glass-card p-5 space-y-3">
                    <h4 class="text-sm font-black uppercase text-red-400 tracking-wide border-b border-white/10 pb-2">Pembatal Puasa</h4>
                    <ul class="list-disc list-inside text-xs text-slate-300 space-y-2 leading-relaxed">
                        <li>Makan dan minum dengan sengaja.</li>
                        <li>Muntah dengan sengaja.</li>
                        <li>Berhubungan suami istri di siang hari.</li>
                        <li>Keluar darah haid atau nifas.</li>
                        <li>Gila atau murtad.</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- TAB: TARGET -->
        <section id="tab-goals" class="section space-y-6">
            <div class="flex justify-between items-center px-1"><h3 class="text-3xl font-black uppercase text-white leading-tight">My Goals</h3><button onclick="addNewGoal()" class="w-12 h-12 bg-purple-600 rounded-2xl flex items-center justify-center text-white shadow-xl active:scale-90 transition-transform"><i data-lucide="plus" class="w-6 h-6"></i></button></div>
            <div id="goals-list-container" class="space-y-5 pb-8"></div>
        </section>

        <!-- TAB: RAPOR -->
        <section id="tab-history" class="section space-y-6">
          <div class="flex justify-between items-center gap-4 px-1">
              <h3 class="text-3xl font-black uppercase text-white leading-tight">Rapor</h3>
              <select id="report-day-filter" class="input-field card-select py-2 px-4 text-xs w-auto h-auto font-bold shadow-md" onchange="handleReportFilterChange(this.value)"></select>
          </div>
          <div class="flex bg-slate-900 p-1.5 rounded-2xl border border-white/5">
            <button id="btn-view-harian" onclick="switchReportView('harian')" class="report-tab-btn active flex-1 py-3">Harian</button>
            <button id="btn-view-bulanan" onclick="switchReportView('bulanan')" class="report-tab-btn flex-1 py-3">Bulanan</button>
          </div>
          <div id="report-harian-view" class="space-y-5"><div class="glass-card p-5"><canvas id="dailyChart" height="220"></canvas></div><div id="daily-log-container" class="space-y-4 pb-8"></div></div>
          <div id="report-bulanan-view" class="hidden space-y-5"><div class="glass-card p-5 mb-4"><canvas id="monthlyTrendChart" height="220"></canvas></div>
              <div class="mini-card-grid pb-8">
                  <div class="stat-card glass-card border-b-4 border-emerald-500"><p class="stat-label">Total Puasa</p><span class="stat-value" id="stat-total-puasa">0</span></div>
                  <div class="stat-card glass-card border-b-4 border-blue-400"><p class="stat-label">Khatam Progress</p><span class="stat-value" id="stat-total-khatam">0%</span></div>
                  <div class="stat-card glass-card border-b-4 border-purple-500"><p class="stat-label">Efisiensi Ibadah</p><span class="stat-value" id="stat-avg-eff">0%</span></div>
                  <div class="stat-card glass-card border-b-4 border-orange-500"><p class="stat-label">Goals Tercapai</p><span class="stat-value" id="stat-goals-done">0</span></div>
              </div>
          </div>
        </section>

        <!-- TAB: SETELAN -->
        <section id="tab-settings" class="section space-y-8">
          <h3 class="text-3xl font-black uppercase text-center text-white">App <span class="gradient-text">Setelan</span></h3>
          <div class="glass-card p-8 text-center space-y-5 relative text-white border border-white/10 shadow-xl mx-2">
              <div class="relative inline-block mx-auto">
                  <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Ramadhan" class="profile-avatar mx-auto shadow-2xl">
                  <div class="absolute bottom-0 right-[-5px] bg-purple-600 p-2.5 rounded-full border-4 border-[#1e1b4b] cursor-pointer active:scale-90 transition-transform" onclick="changeAvatar()"><i data-lucide="camera" class="w-4 h-4 text-white"></i></div>
                  <input type="file" id="avatar-upload-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
              </div>
              <h4 id="profile-display-name-val" class="text-xl font-extrabold text-white tracking-tight">User</h4>
          </div>
          
          <div class="space-y-3 px-2">
              <p class="text-[10px] font-black uppercase text-slate-400 pl-2 tracking-widest border-l-4 border-emerald-500 ml-1 pl-3">Daily Journal</p>
              <div class="glass-card p-6 space-y-5">
                  <div class="grid grid-cols-4 gap-4">
                      <button onclick="setMood('grateful')" class="mood-btn" id="mood-grateful">ğŸ˜‡</button>
                      <button onclick="setMood('happy')" class="mood-btn" id="mood-happy">ğŸ˜Š</button>
                      <button onclick="setMood('tired')" class="mood-btn" id="mood-tired">ğŸ˜´</button>
                      <button onclick="setMood('productive')" class="mood-btn" id="mood-productive">ğŸ”¥</button>
                  </div>
                  <textarea id="journal-input" class="input-field h-32 resize-none text-sm leading-relaxed" placeholder="Bagaimana perjalanan spiritualmu hari ini?"></textarea>
                  <button onclick="saveJournalEntry()" class="btn-primary py-3 text-xs bg-slate-800 hover:bg-slate-700">Simpan Jurnal</button>
              </div>
          </div>

          <div class="space-y-3 px-2">
              <p class="text-[10px] font-black uppercase text-slate-400 pl-2 tracking-widest border-l-4 border-blue-500 ml-1 pl-3">Akun & Data</p>
              <div class="glass-card p-5 space-y-4">
                  <input type="text" id="pref-name" class="input-field text-sm" placeholder="Ganti Username" oninput="checkSettingsChange()">
                  <button id="btn-save-settings" disabled onclick="saveAllSettings()" class="btn-primary py-3 text-xs bg-blue-600">Simpan Perubahan</button>
              </div>
          </div>

          <!-- CLOUD SETUP (GAS) - RESTORED -->
          <div class="space-y-3 px-2 pb-8">
              <p class="text-[10px] font-black uppercase text-slate-400 pl-2 tracking-widest border-l-4 border-indigo-500 ml-1 pl-3">Cloud Sync (GAS)</p>
              <div class="glass-card p-5 space-y-4 bg-indigo-950/20 border-indigo-500/20">
                  <div class="space-y-3 text-[10px] text-slate-300 font-medium text-left leading-relaxed">
                      <p><span class="step-badge">1</span> Siapkan Google Sheet ("Data" & "Users").</p>
                      <p><span class="step-badge">2</span> Salin script backend di bawah.</p>
                      <p><span class="step-badge">3</span> Paste di Apps Script & Deploy Web App.</p>
                      <p><span class="step-badge">4</span> Masukkan URL hasil deploy di sini.</p>
                  </div>
                  <button onclick="copyBackendScript()" class="btn-primary bg-slate-800 border border-indigo-500/30 flex items-center justify-center gap-2 text-[9px] py-3 hover:bg-slate-700"><i data-lucide="copy" class="w-3.5 h-3.5"></i><span>Salin Script Backend</span></button>
                  <input type="text" id="cfg-gs-url" class="input-field text-[10px] py-3" placeholder="URL Web App /exec" oninput="checkSettingsChange()">
                  <div class="grid grid-cols-2 gap-2">
                      <button onclick="saveCloudUrl()" class="btn-primary bg-indigo-600 text-[10px] py-3 hover:bg-indigo-500">Simpan URL</button>
                      <button onclick="testGASConnection()" class="btn-primary bg-slate-800 border border-indigo-500/20 text-[10px] py-3 hover:bg-slate-700">Test Koneksi</button>
                  </div>
                  <div class="grid grid-cols-2 gap-2 mt-2">
                      <button onclick="syncToCloud()" class="btn-primary bg-emerald-700 text-[10px] py-3 hover:bg-emerald-600 flex items-center justify-center gap-1"><i data-lucide="upload-cloud" class="w-3 h-3"></i> Upload Data</button>
                      <button onclick="syncFromCloud()" class="btn-primary bg-blue-700 text-[10px] py-3 hover:bg-blue-600 flex items-center justify-center gap-1"><i data-lucide="download-cloud" class="w-3 h-3"></i> Ambil Data</button>
                  </div>
              </div>
              <button onclick="doLogout()" class="w-full p-4 text-red-400 font-black text-xs border border-red-500/20 rounded-xl bg-red-500/5 hover:bg-red-500/10 uppercase tracking-widest flex items-center justify-center gap-2 mt-4 active:scale-95 transition-transform"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar Akun</button>
          </div>
        </section>
    </main>

    <nav class="bottom-nav">
      <button onclick="navTo('home')" class="nav-btn active" id="btn-home"><i data-lucide="home"></i><span>Home</span></button>
      <button onclick="navTo('progress')" class="nav-btn" id="btn-progress"><i data-lucide="layout-grid"></i><span>Quran</span></button>
      <button onclick="navTo('duas')" class="nav-btn" id="btn-duas"><i data-lucide="book-heart"></i><span>Doa</span></button>
      <button onclick="navTo('goals')" class="nav-btn" id="btn-goals"><i data-lucide="target"></i><span>Target</span></button>
      <button onclick="navTo('history')" class="nav-btn" id="btn-history"><i data-lucide="bar-chart-2"></i><span>Rapor</span></button>
      <button onclick="navTo('settings')" class="nav-btn" id="btn-settings"><i data-lucide="settings"></i><span>Sistem</span></button>
    </nav>
  </div>

  <script>
    // --- VARIABLES FOR BACKEND SCRIPT COPY ---
    var BACKEND_SCRIPT_CODE = `
function doGet(e) { return handleRequest(e); }
function doPost(e) { return handleRequest(e); }

function handleRequest(e) {
  var output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  var params = {};
  try {
    if (e.postData && e.postData.contents) { params = JSON.parse(e.postData.contents); } 
    else if (e.parameter) { params = e.parameter; }
  } catch (err) { return responseJSON({ status: 'error', message: 'Invalid JSON' }); }

  var ss;
  // --- SHEET 1: DATA APLIKASI ---
  try {
     var sheetId = "MASUKAN_ID_SHEET_UTAMA_DISINI"; 
     if (sheetId && sheetId !== "MASUKAN_ID_SHEET_UTAMA_DISINI") { ss = SpreadsheetApp.openById(sheetId); } 
     else { ss = SpreadsheetApp.getActiveSpreadsheet(); }
  } catch (error) { return responseJSON({ status: 'error', message: 'Gagal buka Spreadsheet Utama: ' + error.message }); }

  // --- SHEET 2: BACKUP REGISTRASI & LOG ADMIN ---
  var adminSheetId = "1879GWhm7ZxmieQ_-U3veXJp86HqvCH8QeSjVYaQJjD4"; 

  // --- INIT SHEETS UTAMA ---
  var sheets = {
    users: initSheet(ss, "Users", ["UserID", "DisplayName", "LastSync"]),
    habits: initSheet(ss, "Habits", ["UserID", "Date", "HabitID", "HabitName", "Category", "Status"]),
    quran: initSheet(ss, "QuranTracker", ["UserID", "Type", "Detail", "Status", "LastUpdated"]),
    journals: initSheet(ss, "Journals", ["UserID", "Date", "Mood", "Content"]),
    goals: initSheet(ss, "Goals", ["UserID", "Title", "Target", "Current", "Unit"])
  };

  var action = params.action;
  var userId = params.user_id || "guest";
  var clientData = params.data || {};

  if (action === 'ping') { return responseJSON({ status: 'success', message: 'Connected to Amalin Backend!' }); }

  // --- ACTION KHUSUS: BACKUP REGISTRASI KE SHEET 2 ---
  else if (action === 'register_backup') {
     try {
         var adminSS = SpreadsheetApp.openById(adminSheetId);
         // Format: Timestamp, Email, Nama, Password, Sumber
         var regSheet = initSheet(adminSS, "Backup_Users", ["Timestamp", "Email", "Nama Lengkap", "Password", "Source"]);
         var acc = clientData.userDB;
         if(acc) {
            regSheet.appendRow([new Date().toLocaleString("id-ID"), acc.email, acc.fullName, acc.password, 'Web App']);
            return responseJSON({status: 'success', message: 'User Backup Saved to Sheet 2'});
         } else {
            return responseJSON({status: 'error', message: 'No user data'});
         }
     } catch(e) { return responseJSON({status: 'error', message: 'Backup Error: ' + e.message}); }
  }
  
  // --- ACTION KHUSUS: ADMIN LOG (LOGIN/REGISTER HISTORY) ---
  else if (action === 'admin_auth_log') {
     try {
         var adminSS = SpreadsheetApp.openById(adminSheetId);
         // Format: Timestamp, Email, Nama, Tipe Aktivitas, Status
         var logSheet = initSheet(adminSS, "Auth_Logs", ["Timestamp", "Email", "Nama User", "Tipe Aktivitas", "Status"]);
         
         logSheet.appendRow([
            new Date().toLocaleString("id-ID"), 
            clientData.email, 
            clientData.name, 
            clientData.activityType, 
            clientData.status
         ]);
         return responseJSON({status: 'success', message: 'Log Admin Saved'});
     } catch(e) { return responseJSON({status: 'error', message: e.message}); }
  }

  else if (action === 'save_data') {
    try {
      var timestamp = new Date().toLocaleString("id-ID");
      saveUserData(sheets.users, userId, clientData.profile, timestamp);

      if (clientData.dailyHabits) {
        var habitRows = [];
        for (var dayKey in clientData.dailyHabits) {
           var dayHabits = clientData.dailyHabits[dayKey];
           dayHabits.forEach(function(h) {
             habitRows.push([userId, dayKey, h.id, h.name, h.category, formatCheck(h.done)]);
           });
        }
        if (habitRows.length > 0) appendDataSimple(sheets.habits, habitRows, userId); 
      }

      if (clientData.journals) {
        var journalRows = [];
        for (var dKey in clientData.journals) {
          var j = clientData.journals[dKey];
          if (j.text || j.mood) {
            journalRows.push([userId, dKey, j.mood, j.text]);
          }
        }
        if (journalRows.length > 0) appendDataSimple(sheets.journals, journalRows, userId);
      }

      if (clientData.goals && Array.isArray(clientData.goals)) {
        var goalRows = clientData.goals.map(function(g) {
           return [userId, g.title, g.target, g.current, g.unit];
        });
        if (goalRows.length > 0) appendDataSimple(sheets.goals, goalRows, userId);
      }

      var quranRows = [];
      if (clientData.juzLog && Array.isArray(clientData.juzLog)) {
        clientData.juzLog.forEach(function(done, idx) {
           quranRows.push([userId, "Juz", "Juz " + (idx+1), formatCheck(done), timestamp]);
        });
      }
      if (clientData.quranLog && Array.isArray(clientData.quranLog)) {
         clientData.quranLog.forEach(function(dayLog, dayIdx) {
            dayLog.forEach(function(chk, pIdx) {
              quranRows.push([userId, "Page_Checklist", "Day " + (dayIdx+1) + " Prayer " + pIdx, formatCheck(chk), timestamp]);
            });
         });
      }
      
      if (clientData.manualLog && Array.isArray(clientData.manualLog)) {
         clientData.manualLog.forEach(function(log) {
             quranRows.push([userId, "Manual_Log", log.startSurah + ":" + log.startAyat + " -> " + log.endSurah + ":" + log.endAyat, log.timestamp, timestamp]);
         });
      }
      
      if (quranRows.length > 0) appendDataSimple(sheets.quran, quranRows, userId);

      return responseJSON({ status: 'success', message: 'Data tersimpan rapi ke Sheet 1!' });
    } catch (error) { return responseJSON({ status: 'error', message: 'Save error: ' + error.message }); }
  }
  
  else if (action === 'load_data') {
      return responseJSON({ status: 'success', message: 'Load feature pending', data: null });
  }

  return responseJSON({ status: 'error', message: 'Unknown action' });
}

function initSheet(ss, name, headers) {
  var sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.appendRow(headers);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground("#dcfce7");
    sheet.setFrozenRows(1);
  }
  return sheet;
}

function responseJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
function formatCheck(val) { return val ? "âœ“" : "-"; }

function appendDataSimple(sheet, rows, userId) {
  var lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    var data = sheet.getDataRange().getValues();
    var newData = [];
    var header = data[0];
    for (var i = 1; i < data.length; i++) { if (data[i][0] != userId) { newData.push(data[i]); } }
    rows.forEach(function(r){ newData.push(r); });
    if (newData.length > 0) {
      sheet.getRange(2, 1, lastRow, header.length).clearContent();
      sheet.getRange(2, 1, newData.length, newData[0].length).setValues(newData);
    } else { if(rows.length > 0) sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows); }
  } else { sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows); }
}

function saveUserData(sheet, userId, profileObj, ts) {
  var rows = [[userId, (profileObj ? profileObj.displayName : 'User'), ts]];
  appendDataSimple(sheet, rows, userId);
}`;

    // --- DATA & TEMPLATES ---
    const ramadhanQuotes = ["Puasa adalah perisai. (HR. Bukhari)", "Setiap amalan dilipatgandakan. (HR. Muslim)", "Bau mulut orang berpuasa harum di sisi Allah.", "Sedekah paling utama di Ramadhan.", "Dalam sahur terdapat keberkahan.", "Masuk Ramadhan, pintu surga dibuka.", "Beri buka puasa = pahala orang berpuasa.", "Ramadhan ke Ramadhan penghapus dosa.", "Dua kegembiraan bagi orang berpuasa.", "Sebaik-baik kalian belajar Al-Qur'an.", "Tuntutlah ilmu walau ke negeri Cina.", "Amalan kontinu dicintai Allah.", "Nikmat Tuhan mana yang didustakan?", "Sesudah kesulitan ada kemudahan.", "Tangan di atas lebih baik.", "Senyummu adalah sedekah.", "Manusia terbaik yang bermanfaat.", "Mencari ilmu dimudahkan jalan ke surga.", "Al-Qur'an adalah syafaat di hari kiamat.", "Bertakwalah di mana pun berada.", "Dunia adalah perhiasan sementara.", "Allah melihat hati dan amal kalian.", "Berkata baik atau diam.", "Cukuplah kematian sebagai nasihat.", "Kekayaan sejati adalah kekayaan jiwa.", "Surga di bawah telapak kaki ibu.", "Jaga waktu luang sebelum sibukmu.", "Sebaik-baik doa saat berpuasa.", "Puasalah kalian agar kalian sehat.", "Ya Allah, berkahilah Ramadhan kami."];
    const ramadhanDuas = [];
    for(let i=1; i<=30; i++) ramadhanDuas.push({ day: i, arabic: "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ ÙÙÙŠÙ‡Ù Ù…ÙØ§ ÙŠÙØ±Ù’Ø¶ÙÙŠÙƒÙ ÙˆÙ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙ Ù…ÙÙ…ÙÙ‘Ø§ ÙŠÙØ¤Ù’Ø°ÙÙŠÙƒÙ", latin: "Allahumma inni as'aluka fihi ma yurdhika...", meaning: "Ya Allah, aku memohon kepada-Mu di hari ini apa yang meridhai-Mu..." });
    const templateHabits = [{id:'sw1', name:'Subuh', category:'Shalat Wajib', icon:'zap', done:false},{id:'sw2', name:'Dzuhur', category:'Shalat Wajib', icon:'zap', done:false},{id:'sw3', name:'Ashar', category:'Shalat Wajib', icon:'zap', done:false},{id:'sw4', name:'Maghrib', category:'Shalat Wajib', icon:'zap', done:false},{id:'sw5', name:'Isya', category:'Shalat Wajib', icon:'zap', done:false},{id:'ss1', name:'Tahajud', category:'Sholat Sunnah', icon:'moon', done:false},{id:'ss2', name:'Dhuha', category:'Sholat Sunnah', icon:'sun', done:false},{id:'ss3', name:'Rawatib', category:'Sholat Sunnah', icon:'layers', done:false},{id:'ss4', name:'Witir', category:'Sholat Sunnah', icon:'sparkles', done:false},{id:'ss5', name:'Tarawih', category:'Sholat Sunnah', icon:'stars', done:false},{id:'rc1', name:'Baca Quran 2 lembar setelah sholat wajib', category:'Ramadhan Challenger', icon:'book', done:false},{id:'rc2', name:'Dzikir', category:'Ramadhan Challenger', icon:'smile', done:false},{id:'rc3', name:'Sedekah', category:'Ramadhan Challenger', icon:'heart', done:false},{id:'rc4', name:'Sholawat', category:'Ramadhan Challenger', icon:'heart', done:false},{id:'rc5', name:'Sahur', category:'Ramadhan Challenger', icon:'sun', done:false}];
    const SURAH_LIST = ["Al-Fatihah", "Al-Baqarah", "Ali 'Imran", "An-Nisa'", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Taubah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam", "Ta-Ha", "Al-Anbiya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Asy-Syu'ara'", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Asy-Syura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jasiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Az-Zariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadilah", "Al-Hasyr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddassir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba'", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Insyiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghasyiyah", "Al-Fajr", "Al-Balad", "Asy-Syams", "Al-Lail", "Ad-Duha", "Al-Insyirah", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat", "Al-Qari'ah", "At-Takasur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraisy", "Al-Ma'un", "Al-Kautsar", "Al-Kafirun", "An-Nasr", "Al-Lahab", "Al-Ikhlas", "Al-Falaq", "An-Nas"];

    // --- GLOBAL STATE ---
    let state = {
      user: null, activeDay: localStorage.getItem('ram_active_day') ? parseInt(localStorage.getItem('ram_active_day')) : 1,
      dailyHabits: JSON.parse(localStorage.getItem('ram_daily_habits')) || {}, goals: JSON.parse(localStorage.getItem('ram_custom_goals')) || [],
      journals: JSON.parse(localStorage.getItem('ram_journals')) || {}, 
      quranLog: JSON.parse(localStorage.getItem('khodim_quran_log_gz')) || Array(30).fill(null).map(() => Array(5).fill(false)),
      juzLog: JSON.parse(localStorage.getItem('ram_juz_log')) || Array(30).fill(false),
      manualLog: JSON.parse(localStorage.getItem('ram_manual_log')) || [],
      adzanSettings: JSON.parse(localStorage.getItem('ram_adzan_settings')) || {
          mode: 'beep', // 'beep' or 'full'
          active: { Fajr: true, Dhuhr: true, Asr: true, Maghrib: true, Isha: true }
      },
      notifiedPrayers: [], 
      chartValues: [50, 75, 60, 95, 85, 90, 0], profile: JSON.parse(localStorage.getItem('khodim_profile')) || { displayName: 'Akhi Ramadhan', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Ramadhan' },
      khatamTarget: localStorage.getItem('ram_khatam_target') ? parseInt(localStorage.getItem('ram_khatam_target')) : 1, prayerTimes: null, gsUrl: localStorage.getItem('khodim_gs_url') || 'https://script.google.com/macros/s/AKfycbyPLH5yLkU4DgjZe-oXkVWZBsSNAkzJLqCaZhJ9Cg8pqfTfvxLg-QNLxrNGaLulTEKu2w/exec',
      remindersEnabled: localStorage.getItem('ram_reminders') !== 'false'
    };
    let dailyChart = null;
    let monthlyTrendChart = null;

    // --- HELPER FUNCTIONS ---
    function formatNumber(n) { if(!n) return "0"; return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function cleanNumber(s) { if(!s) return 0; return s.toString().replace(/\./g, ""); }
    function parseTimeStr(ts) { if(!ts) return null; const [h, m] = ts.split(':').map(Number); const d = new Date(); d.setHours(h, m, 0, 0); return d; }

    function saveDailyData() { 
        localStorage.setItem('ram_daily_habits', JSON.stringify(state.dailyHabits)); 
        localStorage.setItem('ram_custom_goals', JSON.stringify(state.goals)); 
        localStorage.setItem('ram_journals', JSON.stringify(state.journals)); 
        localStorage.setItem('khodim_quran_log_gz', JSON.stringify(state.quranLog)); 
        localStorage.setItem('ram_juz_log', JSON.stringify(state.juzLog)); 
        localStorage.setItem('ram_manual_log', JSON.stringify(state.manualLog));
        localStorage.setItem('ram_adzan_settings', JSON.stringify(state.adzanSettings));
    }
    
    function loadDailyData() { 
        const h = localStorage.getItem('ram_daily_habits'); if(h) state.dailyHabits = JSON.parse(h); 
        const g = localStorage.getItem('ram_custom_goals'); if(g) state.goals = JSON.parse(g); 
        const j = localStorage.getItem('ram_journals'); if(j) state.journals = JSON.parse(j); 
        const l = localStorage.getItem('khodim_quran_log_gz'); if(l) state.quranLog = JSON.parse(l); 
        const jl = localStorage.getItem('ram_juz_log'); if(jl) state.juzLog = JSON.parse(jl); 
        const ml = localStorage.getItem('ram_manual_log'); if(ml) state.manualLog = JSON.parse(ml);
        const as = localStorage.getItem('ram_adzan_settings'); if(as) state.adzanSettings = JSON.parse(as);
    }

    // --- CORE FUNCTIONS (Moved Up for Hoisting) ---

    function runBackgroundSystem() {
        if (!state.gsUrl) return;
        
        const pendingReg = localStorage.getItem('khodim_pending_reg');
        if (pendingReg) {
            const userData = JSON.parse(pendingReg);
            fetch(state.gsUrl, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'register_backup',
                    data: { userDB: userData }
                })
            }).then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    console.log('Background Sync: Registration Backup Success');
                    localStorage.removeItem('khodim_pending_reg');
                }
            }).catch(err => console.log('Background Sync Error:', err));
        }
        
        const pendingLogin = localStorage.getItem('khodim_pending_login');
        if (pendingLogin) {
            const loginData = JSON.parse(pendingLogin);
            fetch(state.gsUrl, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'admin_auth_log',
                    data: loginData
                })
            }).then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    console.log('Background Sync: Admin Log Success');
                    localStorage.removeItem('khodim_pending_login');
                }
            }).catch(err => console.log('Background Sync Error:', err));
        }
    }

    function showApp() {
      document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden');
      const hF = document.getElementById('home-date-filter'), rF = document.getElementById('report-day-filter');
      const urlInput = document.getElementById('cfg-gs-url');
      if (urlInput) urlInput.value = state.gsUrl; // Autofill URL
      if(hF) { hF.innerHTML = ''; for(let i=1; i<=30; i++) { const o = document.createElement('option'); o.value = i; o.innerText = `Hari ke-${i}`; if(i === state.activeDay) o.selected = true; hF.appendChild(o); } }
      if(rF) { rF.innerHTML = '<option value="all">Semua Hari</option>'; for(let i=1; i<=30; i++) { const o = document.createElement('option'); o.value = i; o.innerText = `Hari ${i}`; rF.appendChild(o); } }
      updateQuranPlanner(state.khatamTarget); renderHabits(); renderMonthlyTable(); renderGoals(); renderDuaList(); renderJournal(); updateUI(); updateDate(); detectLocation();
      populateSurahDropdowns(); renderJuzList(); 
      setTimeout(runBackgroundSystem, 2000);
    }

    function navTo(t) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${t}`).classList.add('active');
      if(t==='history') switchReportView('harian'); if(t==='progress') { renderMonthlyTable(); renderJuzList(); renderManualLog(); } if(t==='goals') renderGoals(); if(t==='duas') renderDuaList(); if(t==='settings') renderJournal();
      lucide.createIcons();
    }

    function updateUI() {
      updateMonthlyUI();
      if(!state.dailyHabits[`day${state.activeDay}`]) state.dailyHabits[`day${state.activeDay}`] = JSON.parse(JSON.stringify(templateHabits));
      const h = state.dailyHabits[`day${state.activeDay}`];
      if(document.getElementById('stat-wajib')) document.getElementById('stat-wajib').innerText = `${h.filter(x => x.category === 'Shalat Wajib' && x.done).length}/5`;
      if(document.getElementById('bar-wajib')) document.getElementById('bar-wajib').style.width = (h.filter(x => x.category === 'Shalat Wajib' && x.done).length/5*100) + '%';
      const ssDone = h.filter(x => (x.category === 'Sholat Sunnah') && x.done).length;
      if(document.getElementById('stat-sunnah')) document.getElementById('stat-sunnah').innerText = `${ssDone}/5`;
      if(document.getElementById('bar-sunnah')) document.getElementById('bar-sunnah').style.width = (ssDone/5*100) + '%';
      const rcDone = h.filter(x => x.category === 'Ramadhan Challenger' && x.done).length;
      if(document.getElementById('stat-challenger')) document.getElementById('stat-challenger').innerText = `${rcDone}/5`;
      if(document.getElementById('bar-challenger')) document.getElementById('bar-challenger').style.width = (rcDone/5*100) + '%';
      
      const bell = document.getElementById('main-bell-icon');
      if(bell) {
          const anyActive = Object.values(state.adzanSettings.active).some(v => v);
          bell.setAttribute('data-lucide', anyActive ? 'bell-ring' : 'bell-off');
          bell.style.color = anyActive ? '#a855f7' : '#64748b';
          lucide.createIcons();
      }
      if(document.getElementById('user-name-display')) document.getElementById('user-name-display').innerText = state.profile.displayName.split(' ')[0];
      if(document.getElementById('profile-display-name-val')) document.getElementById('profile-display-name-val').innerText = state.profile.displayName;
      
      const dayJournal = state.journals[`day${state.activeDay}`];
      document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.toggle('active', dayJournal && dayJournal.mood === btn.id.split('-')[1]));
      
      if(document.getElementById('juz-list-container')) renderJuzList();
    }

    // --- LOGIC FUNCTIONS ---
    function toggleQuranLog(d, p) { state.quranLog[d][p] = !state.quranLog[d][p]; saveDailyData(); renderMonthlyTable(); updateMonthlyUI(); }
    function setMood(m) { if(!state.journals[`day${state.activeDay}`]) state.journals[`day${state.activeDay}`] = { mood: '', text: '' }; state.journals[`day${state.activeDay}`].mood = m; saveDailyData(); updateUI(); }

    function updateDate() {
      const mD = document.getElementById('header-masehi-date'), hD = document.getElementById('header-hijri-date'), cD = document.getElementById('card-hijri-display');
      const now = new Date(); const ds = now.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' }).toUpperCase();
      if(mD) mD.innerText = ds; if(hD) hD.innerText = `${state.activeDay} RAMADHAN 1447 H`; if(cD) cD.innerText = `${state.activeDay} RAMADHAN 1447 H`;
      const qE = document.getElementById('daily-inspiration-text'); if(qE) qE.innerText = `"${ramadhanQuotes[(state.activeDay-1)%30]}"`;
    }

    function updateMonthlyUI() {
      let dC = 0; state.quranLog.forEach(d => d.forEach(p => { if(p) dC++; }));
      const dp = Math.round((dC/150)*604), sisa = 604-dp, pc = Math.min(Math.round((dC/150)*100),100);
      const cE = document.getElementById('total-page-count'), pE = document.getElementById('total-page-percent'), bE = document.getElementById('total-page-bar'), rsE = document.getElementById('remaining-pages-label'), sE = document.getElementById('stat-khatam'), sbE = document.getElementById('bar-khatam');
      if(cE) cE.innerText = dp; if(pE) pE.innerText = pc + '%'; if(bE) bE.style.width = pc + '%'; if(rsE) rsE.innerText = `SISA ${sisa} Hal`;
      if(sE) sE.innerText = `${dp}/604`; if(sbE) sbE.style.width = pc + '%';
    }

    function renderJuzList() {
        const c = document.getElementById('juz-list-container'); if(!c) return; 
        c.innerHTML = '';
        state.juzLog.forEach((done, i) => {
            const tile = document.createElement('div');
            tile.className = `juz-tile ${done ? 'checked' : ''}`;
            tile.onclick = () => toggleJuz(i);
            const checkHTML = done ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : '';
            tile.innerHTML = `<div class="juz-checkbox">${checkHTML}</div><span class="juz-text">Juz ${i+1}</span>`;
            c.appendChild(tile);
        });
        
        let completedCount = state.juzLog.filter(x => x).length;
        const pct = Math.round((completedCount / 30) * 100);
        const pBar = document.getElementById('juz-progress-bar');
        const pTxt = document.getElementById('juz-progress-percent');
        const cTxt = document.getElementById('juz-completed-count');
        if(pBar) pBar.style.width = `${pct}%`;
        if(pTxt) pTxt.innerText = `${pct}%`;
        if(cTxt) cTxt.innerText = completedCount;
        lucide.createIcons();
    }

    function toggleJuz(idx) { state.juzLog[idx] = !state.juzLog[idx]; saveDailyData(); renderJuzList(); }

    function resetJuzProgress() {
        Swal.fire({ title: 'Reset Progres Juz?', text: "Semua checklist Juz akan dihapus!", icon: 'warning', background: '#020617', color: '#fff', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Reset!', cancelButtonText: 'Batal' }).then((result) => {
            if (result.isConfirmed) { state.juzLog = Array(30).fill(false); saveDailyData(); renderJuzList(); Swal.fire({ title: 'Direset!', text: 'Progres Juz kembali ke 0.', icon: 'success', background: '#020617', color: '#fff', timer: 1500, showConfirmButton: false }); }
        });
    }

    function resetPageProgress() {
        Swal.fire({ title: 'Reset Progres Halaman?', text: "Semua checklist halaman sholat akan dihapus!", icon: 'warning', background: '#020617', color: '#fff', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Reset!', cancelButtonText: 'Batal' }).then((result) => {
            if (result.isConfirmed) { state.quranLog = Array(30).fill(null).map(() => Array(5).fill(false)); saveDailyData(); renderMonthlyTable(); updateMonthlyUI(); Swal.fire({ title: 'Direset!', text: 'Progres Halaman kembali ke 0.', icon: 'success', background: '#020617', color: '#fff', timer: 1500, showConfirmButton: false }); }
        });
    }

    function switchQuranTab(tab) {
        document.getElementById('view-quran-juz').classList.toggle('hidden', tab !== 'juz');
        document.getElementById('view-quran-page').classList.toggle('hidden', tab !== 'page');
        document.getElementById('view-quran-manual').classList.toggle('hidden', tab !== 'manual'); 
        
        const btnJuz = document.getElementById('btn-quran-juz');
        const btnPage = document.getElementById('btn-quran-page');
        const btnManual = document.getElementById('btn-quran-manual');
        
        [btnJuz, btnPage, btnManual].forEach(btn => btn.classList.remove('active'));
        
        if(tab === 'juz') btnJuz.classList.add('active');
        else if(tab === 'page') btnPage.classList.add('active');
        else if(tab === 'manual') btnManual.classList.add('active');
        
        if(tab === 'manual') renderManualLog();
    }

    function switchDuaTab(tab) {
        document.getElementById('view-dua-doa').classList.toggle('hidden', tab !== 'doa');
        document.getElementById('view-dua-niat').classList.toggle('hidden', tab !== 'niat');
        document.getElementById('view-dua-fiqih').classList.toggle('hidden', tab !== 'fiqih');
        
        const btnDoa = document.getElementById('btn-dua-doa');
        const btnNiat = document.getElementById('btn-dua-niat');
        const btnFiqih = document.getElementById('btn-dua-fiqih');
        
        [btnDoa, btnNiat, btnFiqih].forEach(btn => btn.classList.remove('active'));
        
        if(tab === 'doa') btnDoa.classList.add('active');
        else if(tab === 'niat') btnNiat.classList.add('active');
        else if(tab === 'fiqih') btnFiqih.classList.add('active');
    }

    function toggleAdzanModal(show) {
        const modal = document.getElementById('modal-adzan-settings');
        if (show) { modal.classList.add('active'); renderAdzanSettings(); } 
        else { modal.classList.remove('active'); }
    }

    function switchAdzanTab(mode) {
        state.adzanSettings.mode = mode; saveDailyData(); renderAdzanSettings();
    }

    function toggleAdzanActive(prayerName) {
        state.adzanSettings.active[prayerName] = !state.adzanSettings.active[prayerName];
        saveDailyData(); renderAdzanSettings();
    }

    function renderAdzanSettings() {
        const btnBeep = document.getElementById('tab-adzan-beep');
        const btnFull = document.getElementById('tab-adzan-full');
        if(state.adzanSettings.mode === 'beep') {
            btnBeep.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-white bg-purple-600 transition-all';
            btnFull.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all';
        } else {
            btnFull.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-white bg-purple-600 transition-all';
            btnBeep.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all';
        }
        const container = document.getElementById('adzan-toggle-list');
        container.innerHTML = '';
        const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        const prayerLabels = {'Fajr': 'Subuh', 'Dhuhr': 'Dzhur', 'Asr': 'Ashar', 'Maghrib': 'Maghrib', 'Isha': 'Isya'};
        prayers.forEach(p => {
            const isActive = state.adzanSettings.active[p];
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center bg-slate-800/50 p-3 rounded-xl border border-white/5';
            div.innerHTML = `<span class="text-sm font-bold text-white">${prayerLabels[p]}</span><div onclick="toggleAdzanActive('${p}')" class="adzan-toggle ${isActive ? 'active' : ''}"></div>`;
            container.appendChild(div);
        });
    }

    function renderHabits() {
      const c = document.getElementById('habit-container'); if(!c) return; c.innerHTML = '';
      if(!state.dailyHabits[`day${state.activeDay}`]) state.dailyHabits[`day${state.activeDay}`] = JSON.parse(JSON.stringify(templateHabits));
      const h = state.dailyHabits[`day${state.activeDay}`];
      ['Shalat Wajib', 'Sholat Sunnah', 'Ramadhan Challenger'].forEach(cat => {
        const list = h.filter(x => x.category === cat); if(list.length === 0) return;
        const div = document.createElement('div'); div.className = 'space-y-3';
        div.innerHTML = `<h4 class="text-[10px] font-black text-purple-400 uppercase tracking-widest pl-2 border-l-2 border-purple-500">${cat}</h4>`;
        list.forEach(x => {
          const idx = h.findIndex(item => item.id === x.id); const item = document.createElement('div');
          item.className = `habit-item shadow-sm ${x.done ? 'completed' : ''}`;
          item.onclick = () => { h[idx].done = !h[idx].done; saveDailyData(); renderHabits(); updateUI(); };
          item.innerHTML = `<div class="w-9 h-9 rounded-xl bg-indigo-900/40 flex items-center justify-center mr-3.5 shadow-sm"><i data-lucide="${x.icon}" class="w-5 h-5 text-purple-400"></i></div><div class="flex-1"><h4 class="text-xs font-extrabold text-white">${x.name}</h4></div><div class="w-6.5 h-6.5 rounded-lg border-2 border-slate-700 flex items-center justify-center transition-all ${x.done ? 'bg-emerald-500 border-emerald-500 text-white' : ''}">${x.done ? 'âœ”ï¸' : ''}</div>`;
          div.appendChild(item);
        });
        c.appendChild(div);
      }); lucide.createIcons();
    }

    function renderJournal() {
      const entry = state.journals[`day${state.activeDay}`] || { mood: '', text: '' };
      const input = document.getElementById('journal-input'); if(input) input.value = entry.text;
      updateUI();
    }

    function renderMonthlyTable() {
      const b = document.getElementById('progress-table-body'); if(!b) return; b.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const r = document.createElement('tr'); 
        let c = `<td class="font-black text-slate-400 text-[10px] py-4 border-r border-white/5">${i + 1}</td>`;
        for (let j = 0; j < 5; j++) {
          const chk = state.quranLog[i][j], k = (i * 5) + j;
          const label = k === 149 ? `${Math.floor(k*(604/150))+1}-604` : `${Math.floor(k*(604/150))+1}-${Math.floor((k+1)*(604/150))}`;
          c += `<td><div class="flex flex-col items-center gap-1"><div class="check-box ${chk?'checked':''}" onclick="toggleQuranLog(${i}, ${j})">${chk?'<i data-lucide="check" class="w-3.5 h-3.5"></i>':''}</div><span class="text-[8px] font-bold text-slate-300">${label}</span></div></td>`;
        }
        r.innerHTML = c; b.appendChild(r);
      } lucide.createIcons();
    }

    function renderDuaList() {
      const c = document.getElementById('dua-list-container'); if(!c) return; c.innerHTML = '';
      ramadhanDuas.forEach(d => {
        const div = document.createElement('div'); div.className = 'dua-card-list space-y-4';
        div.innerHTML = `<p class="text-[9px] font-black uppercase text-purple-400 tracking-widest mb-1 text-white">Doa Hari Ke-${d.day}</p><p class="text-xl font-serif text-right text-white leading-loose">${d.arabic}</p><p class="text-xs italic text-slate-400">${d.latin}</p><p class="text-sm font-bold text-emerald-400 leading-snug">"${d.meaning}"</p>`;
        c.appendChild(div);
      });
    }

    function renderGoals() {
      const c = document.getElementById('goals-list-container'); if(!c) return; c.innerHTML = '';
      state.goals.forEach((g, i) => {
        const p = Math.min(Math.round((g.current/g.target)*100), 100);
        const div = document.createElement('div'); div.className = 'goal-card glass-card p-5 mb-4';
        div.innerHTML = `<div class="flex justify-between items-start text-white"><div><h4 class="text-sm font-black uppercase tracking-wide">${g.title}</h4><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">${formatNumber(g.current)} / ${formatNumber(g.target)} ${g.unit}</p></div><div class="flex gap-2"><button onclick="editGoal(${i})" class="text-purple-400 p-2 active:bg-purple-500/20 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="deleteGoal(${i})" class="text-red-500/50 p-2 active:bg-red-500/20 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="bg-black/30 h-3 rounded-full overflow-hidden mt-3"><div class="bg-gradient-to-r from-purple-500 to-emerald-400 h-full shadow-[0_0_10px_rgba(168,85,247,0.5)]" style="width:${p}%"></div></div><div class="flex justify-between items-center mt-4"><span class="text-xs font-black text-emerald-400">${p}%</span><div class="flex gap-3"><button onclick="updateGoalProgress(${i},-1)" class="w-10 h-10 rounded-xl bg-slate-800 text-white font-bold active:scale-90 transition-transform">-</button><button onclick="updateGoalProgress(${i},1)" class="w-10 h-10 rounded-xl bg-purple-600 text-white font-bold shadow-lg active:scale-90 transition-transform">+</button></div></div>`;
        c.appendChild(div);
      }); lucide.createIcons();
    }

    function generateDailyReport() {
        const container = document.getElementById('daily-log-container'); if(!container) return; container.innerHTML = '';
        const filterVal = document.getElementById('report-day-filter').value;
        for (let i = 1; i <= 30; i++) {
            if (filterVal !== 'all' && parseInt(filterVal) !== i) continue;
            const h = state.dailyHabits[`day${i}`] || JSON.parse(JSON.stringify(templateHabits));
            const dc = h.filter(x => x.done).length, p = Math.round((dc / h.length) * 100);
            const card = document.createElement('div'); card.className = 'glass-card p-5 mb-4 border border-white/5';
            const logHTML = h.filter(x => x.category === 'Shalat Wajib').map(x => `<div class="report-log-item text-white flex flex-col items-center gap-1"><div class="w-8 h-8 rounded-full flex items-center justify-center ${x.done ? 'bg-emerald-900/40 text-emerald-400 border border-emerald-500/30' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${x.done ? 'âœ”ï¸' : 'âŒ'}</div><span class="text-[9px] font-bold text-slate-400 uppercase">${x.name.substring(0,3)}</span></div>`).join('');
            card.innerHTML = `<div class="flex justify-between items-center mb-4 pb-2 border-b border-white/10 text-white"><p class="text-xs font-black text-purple-400 uppercase tracking-widest">${i} RAMADHAN</p><span class="text-xs font-black text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded-lg">${p}% Tuntas</span></div><div class="report-log-grid">${logHTML}</div>`;
            container.appendChild(card);
        } lucide.createIcons();
    }

    function initDailyChart() { const ctx = document.getElementById('dailyChart'); if(!ctx) return; if (dailyChart) dailyChart.destroy(); dailyChart = new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'], datasets: [{ label: 'Efisiensi', data: state.chartValues, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false, min: 0, max: 100 }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } } } } }); }
    function initMonthlyTrendChart() { const ctx = document.getElementById('monthlyTrendChart'); if(!ctx) return; if (monthlyTrendChart) monthlyTrendChart.destroy(); const labels = Array.from({length: 30}, (_, i) => i + 1); const data = labels.map(day => { const h = state.dailyHabits[`day${day}`] || templateHabits; return Math.round((h.filter(x => x.done).length / h.length) * 100); }); monthlyTrendChart = new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Efisiensi', data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3, pointRadius: 2 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false, min: 0, max: 100 }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 8 } } } } } }); }

    function switchReportView(v) { 
        document.getElementById('report-harian-view').classList.toggle('hidden', v !== 'harian'); 
        document.getElementById('report-bulanan-view').classList.toggle('hidden', v !== 'bulanan'); 
        document.querySelectorAll('.report-tab-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase() === v));
        if(v==='bulanan') {
            let pD = 0, eS = 0;
            for(let i=1; i<=30; i++){ const h = state.dailyHabits[`day${i}`]; if(h && h.filter(x=>x.done).length > 0){ pD++; eS += (h.filter(x=>x.done).length/h.length); } }
            let qD = 0; state.quranLog.forEach(d=>d.forEach(p=>{ if(p) qD++; }));
            document.getElementById('stat-total-puasa').innerText = pD;
            document.getElementById('stat-total-khatam').innerText = Math.min(Math.round((qD/150)*100), 100) + '%';
            document.getElementById('stat-avg-eff').innerText = (pD > 0 ? Math.round((eS/pD)*100) : 0) + '%';
            document.getElementById('stat-goals-done').innerText = state.goals.filter(g => g.current >= g.target).length;
            setTimeout(initMonthlyTrendChart, 100);
        } else { setTimeout(initDailyChart, 100); generateDailyReport(); }
    }

    function handleReportFilterChange(val) { generateDailyReport(); }
    function changeActiveDay(day) { state.activeDay = parseInt(day); localStorage.setItem('ram_active_day', state.activeDay); renderHabits(); renderJournal(); updateUI(); updateDate(); }
    function handleQuranPlannerSlider(val) { updateQuranPlanner(val); }
    function updateQuranPlanner(t) { state.khatamTarget = parseInt(t); const total = 604 * t, pD = Math.ceil(total/30), pP = Math.ceil(pD/5); const tv = document.getElementById('khatam-target-val'), td = document.getElementById('target-pages-day'), tp = document.getElementById('target-pages-prayer'); if(tv) tv.innerText = `${t} Kali`; if(td) td.innerText = `${pD} Halaman`; if(tp) tp.innerText = `${pP} Halaman`; updateMonthlyUI(); }

    async function addNewGoal() { 
        const { value: fV } = await Swal.fire({ title: 'Tambah Target', background: '#020617', color: '#fff', html: '<input id="sw-gt" class="swal2-input" placeholder="Nama Target"><input id="sw-gs" class="swal2-input" placeholder="Sasaran"><input id="sw-gu" class="swal2-input" placeholder="Satuan">', didOpen: () => { document.getElementById('sw-gs').addEventListener('input', (e) => { let v = e.target.value.replace(/\D/g, ""); e.target.value = formatNumber(v); }); }, preConfirm: () => ({ title: document.getElementById('sw-gt').value, target: parseInt(cleanNumber(document.getElementById('sw-gs').value)), unit: document.getElementById('sw-gu').value }) }); 
        if (fV && fV.title && !isNaN(fV.target)) { state.goals.push({ ...fV, current: 0 }); saveDailyData(); renderGoals(); } 
    }

    async function editGoal(idx) { 
        const g = state.goals[idx]; 
        const { value: fV } = await Swal.fire({ title: 'Edit Target', background: '#020617', color: '#fff', html: `<input id="e-gt" class="swal2-input" value="${g.title}"><input id="e-gs" class="swal2-input" value="${formatNumber(g.target)}"><input id="e-gc" class="swal2-input" value="${formatNumber(g.current)}"><input id="e-gu" class="swal2-input" value="${g.unit}">`, didOpen: () => { ['e-gs', 'e-gc'].forEach(id => { document.getElementById(id).addEventListener('input', (e) => { let v = e.target.value.replace(/\D/g, ""); e.target.value = formatNumber(v); }); }); }, preConfirm: () => ({ title: document.getElementById('e-gt').value, target: parseInt(cleanNumber(document.getElementById('e-gs').value)), current: parseInt(cleanNumber(document.getElementById('e-gc').value)), unit: document.getElementById('e-gu').value }) }); 
        if (fV && fV.title && !isNaN(fV.target)) { state.goals[idx] = fV; saveDailyData(); renderGoals(); } 
    }

    function updateGoalProgress(i, a) { let step = (state.goals[i].unit.toLowerCase()==='rupiah' || state.goals[i].unit.toLowerCase()==='rp') ? 50000 : 1; state.goals[i].current = Math.max(0, state.goals[i].current+(a*step)); saveDailyData(); renderGoals(); }
    function deleteGoal(i) { state.goals.splice(i, 1); saveDailyData(); renderGoals(); }
    
    function toggleReminders(val) { 
        if (val && Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    state.remindersEnabled = true; localStorage.setItem('ram_reminders', true); updateUI();
                    Swal.fire({title:'Reminder Aktif!', text:'Notifikasi akan muncul saat waktu sholat.', icon:'success', timer:1500, showConfirmButton:false});
                    new Notification("Amalin App", { body: "Notifikasi sholat diaktifkan!", icon: "https://cdn-icons-png.flaticon.com/512/4358/4358666.png" });
                } else { Swal.fire('Izin Ditolak', 'Mohon izinkan notifikasi di browser untuk fitur ini.', 'error'); state.remindersEnabled = false; updateUI(); }
            });
        } else { state.remindersEnabled = val; localStorage.setItem('ram_reminders', val); updateUI(); if(val) Swal.fire({title:'Reminder Aktif!', icon:'success', timer:800, showConfirmButton:false}); }
    }

    function sendPrayerNotification(name, time) {
        if (!state.adzanSettings.active[name]) return;
        const title = `Waktunya Sholat ${name}!`;
        const bodyText = state.adzanSettings.mode === 'full' ? `Adzan berkumandang untuk ${name} (${time}).` : `Waktu ${name} telah masuk (${time}).`;
        const options = { body: bodyText, icon: 'https://cdn-icons-png.flaticon.com/512/4358/4358666.png', vibrate: [200, 100, 200] };
        if (Notification.permission === "granted") new Notification(title, options);
        if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        Swal.fire({ title: title, text: bodyText, icon: 'info', timer: 10000, showConfirmButton: true, confirmButtonText: 'Tutup' });
    }

    function checkSettingsChange() { document.getElementById('btn-save-settings').disabled = false; }
    function saveAllSettings() { state.profile.displayName = document.getElementById('pref-name').value; saveDailyData(); updateUI(); Swal.fire({ icon:'success', title:'Tersimpan!', timer:1000 }); }
    function changeAvatar() { document.getElementById('avatar-upload-input').click(); }
    function handleImageUpload(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { state.profile.avatar = ev.target.result; document.getElementById('user-avatar').src = ev.target.result; saveDailyData(); updateUI(); }; r.readAsDataURL(f); }
    function saveCloudUrl() { const u = document.getElementById('cfg-gs-url').value; state.gsUrl = u; localStorage.setItem('khodim_gs_url', u); Swal.fire({ icon:'success', title:'URL Disimpan!' }); }
    function copyBackendScript() { const c = BACKEND_SCRIPT_CODE; const t = document.createElement("textarea"); t.value = c; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); Swal.fire({ icon:'success', title:'Script Backend Tersalin!', text: 'Silakan paste di editor Apps Script.' }); }
    
    async function testGASConnection() { 
        const u = document.getElementById('cfg-gs-url').value; 
        if(!u) return Swal.fire('URL Kosong', '', 'warning'); 
        try { const res = await fetch(u, { method:'POST', body:JSON.stringify({action:'ping'}) }); const json = await res.json(); if(json.status === 'success') Swal.fire('Terkoneksi!', 'Sinyal terkirim ke GAS.', 'success'); else throw new Error(json.message); } catch (e) { Swal.fire('Gagal', 'Tidak dapat terhubung ke backend: ' + e.message, 'error'); } 
    }

    async function syncToCloud() {
        if(!state.gsUrl) return Swal.fire('Error', 'URL Backend belum diatur di menu Settings.', 'error');
        const payload = { action: 'save_data', user_id: state.user ? state.user.name : 'guest', data: { dailyHabits: state.dailyHabits, goals: state.goals, journals: state.journals, quranLog: state.quranLog, juzLog: state.juzLog, manualLog: state.manualLog, profile: state.profile, userDB: { email: state.user.email, fullName: state.user.fullName, password: '***' } } };
        try { Swal.fire({title: 'Menyimpan...', didOpen: () => Swal.showLoading()}); const res = await fetch(state.gsUrl, { method: 'POST', body: JSON.stringify(payload) }); const json = await res.json(); if(json.status === 'success') { Swal.fire('Berhasil', 'Data berhasil disimpan ke Google Sheets.', 'success'); } else { throw new Error(json.message); } } catch (e) { Swal.fire('Gagal Upload', 'Terjadi kesalahan: ' + e.message, 'error'); }
    }

    async function syncFromCloud() {
        if(!state.gsUrl) return Swal.fire('Error', 'URL Backend belum diatur di menu Settings.', 'error');
        const payload = { action: 'load_data', user_id: state.user ? state.user.name : 'guest' };
        try { Swal.fire({title: 'Mengambil...', didOpen: () => Swal.showLoading()}); const res = await fetch(state.gsUrl, { method: 'POST', body: JSON.stringify(payload) }); const json = await res.json(); if(json.status === 'success' && json.data) { const d = json.data; if(d.dailyHabits) state.dailyHabits = d.dailyHabits; if(d.goals) state.goals = d.goals; if(d.journals) state.journals = d.journals; if(d.quranLog) state.quranLog = d.quranLog; if(d.juzLog) state.juzLog = d.juzLog; if(d.manualLog) state.manualLog = d.manualLog; if(d.profile) state.profile = d.profile; saveDailyData(); updateUI(); Swal.fire('Berhasil', 'Data berhasil dipulihkan dari Google Sheets.', 'success'); } else { Swal.fire('Info', 'Data tidak ditemukan di server.', 'info'); } } catch (e) { Swal.fire('Gagal Download', 'Terjadi kesalahan: ' + e.message, 'error'); }
    }

    function togglePasswordVisibility(fieldId, btn) { const input = document.getElementById(fieldId); if (input.type === "password") { input.type = "text"; btn.innerHTML = '<i data-lucide="eye-off" class="w-5 h-5"></i>'; } else { input.type = "password"; btn.innerHTML = '<i data-lucide="eye" class="w-5 h-5"></i>'; } lucide.createIcons(); }

    function populateSurahDropdowns() {
        const startSelect = document.getElementById('manual-surah-start'); const endSelect = document.getElementById('manual-surah-end'); if(!startSelect || !endSelect) return;
        startSelect.innerHTML = '<option value="" disabled selected>Pilih Surat Awal</option>'; endSelect.innerHTML = '<option value="" disabled selected>Pilih Surat Akhir</option>';
        SURAH_LIST.forEach((surah, index) => { const optionStart = document.createElement('option'); optionStart.value = surah; optionStart.text = `${index + 1}. ${surah}`; startSelect.appendChild(optionStart); const optionEnd = document.createElement('option'); optionEnd.value = surah; optionEnd.text = `${index + 1}. ${surah}`; endSelect.appendChild(optionEnd); });
    }

    function saveManualEntry() {
        const sStart = document.getElementById('manual-surah-start').value; const aStart = document.getElementById('manual-ayat-start').value; const sEnd = document.getElementById('manual-surah-end').value; const aEnd = document.getElementById('manual-ayat-end').value;
        if (!sStart || !aStart || !sEnd || !aEnd) { Swal.fire('Data Tidak Lengkap', 'Mohon isi semua data surat dan ayat.', 'warning'); return; }
        const entry = { id: Date.now(), startSurah: sStart, startAyat: aStart, endSurah: sEnd, endAyat: aEnd, timestamp: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) };
        state.manualLog.unshift(entry); saveDailyData(); renderManualLog(); document.getElementById('manual-ayat-start').value = ''; document.getElementById('manual-ayat-end').value = ''; Swal.fire({ icon: 'success', title: 'Tersimpan', showConfirmButton: false, timer: 1000 });
    }

    function renderManualLog() {
        const container = document.getElementById('manual-log-list'); if (!container) return; container.innerHTML = '';
        if (state.manualLog.length === 0) { container.innerHTML = '<p class="text-center text-xs text-slate-500 py-4 italic">Belum ada catatan bacaan.</p>'; return; }
        state.manualLog.forEach(item => {
            const div = document.createElement('div'); div.className = 'glass-card p-4 flex justify-between items-center border border-white/5 active:bg-slate-900 transition-colors';
            div.innerHTML = `<div><div class="flex items-center gap-2 mb-1.5 flex-wrap"><span class="text-xs font-bold bg-purple-500/20 text-purple-300 px-2.5 py-1 rounded-lg">${item.startSurah}:${item.startAyat}</span><i data-lucide="arrow-right" class="w-3.5 h-3.5 text-slate-500"></i><span class="text-xs font-bold bg-emerald-500/20 text-emerald-300 px-2.5 py-1 rounded-lg">${item.endSurah}:${item.endAyat}</span></div><p class="text-[10px] text-slate-400 font-medium pl-1">${item.timestamp}</p></div><button onclick="deleteManualEntry(${item.id})" class="text-slate-500 hover:text-red-400 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
            container.appendChild(div);
        }); lucide.createIcons();
    }

    function deleteManualEntry(id) { state.manualLog = state.manualLog.filter(item => item.id !== id); saveDailyData(); renderManualLog(); }
    function resetManualLog() { Swal.fire({ title: 'Hapus Riwayat?', text: "Semua catatan bacaan manual akan dihapus!", icon: 'warning', background: '#020617', color: '#fff', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Hapus!' }).then((result) => { if (result.isConfirmed) { state.manualLog = []; saveDailyData(); renderManualLog(); Swal.fire({ title: 'Terhapus!', icon: 'success', background: '#020617', color: '#fff', timer: 1000, showConfirmButton: false }); } }); }

    // --- REGISTER BUTTON LOGIC (FIXED) ---
    function doRegister() {
        const name = document.getElementById('reg-name').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const pass = document.getElementById('reg-pass').value.trim();

        if (!name || !email || !pass) {
            Swal.fire({ icon: 'warning', title: 'Data Belum Lengkap', text: 'Mohon isi Nama, Email, dan Password.', background: '#020617', color: '#fff', confirmButtonColor: '#a855f7' });
            return;
        }

        // Get Existing Users (Ensure Array) - SMART FIX FOR LEGACY DATA
        let dbString = localStorage.getItem('khodim_users_db');
        let dbUsers = [];
        if (dbString) {
            try {
                let parsed = JSON.parse(dbString);
                if (Array.isArray(parsed)) dbUsers = parsed;
                else dbUsers = [parsed]; // Fix if old data was single object
            } catch(e) { dbUsers = []; }
        }

        // Check Duplicate
        if(dbUsers.some(u => u.email === email)) {
             Swal.fire({ icon: 'error', title: 'Gagal', text: 'Email sudah terdaftar.', background: '#020617', color: '#fff' });
             return;
        }

        const newUser = { name: name.split(' ')[0], fullName: name, email: email, password: pass };
        dbUsers.push(newUser);
        localStorage.setItem('khodim_users_db', JSON.stringify(dbUsers)); // Save to Permanent DB

        // Save pending registration for background sync
        localStorage.setItem('khodim_pending_reg', JSON.stringify(newUser));

        // Auto Login (Set Session)
        state.user = { name: newUser.name, email: newUser.email };
        state.profile.displayName = newUser.fullName; 
        localStorage.setItem('khodim_active_session', JSON.stringify(state.user));
        saveDailyData(); 

        Swal.fire({
            icon: 'success',
            title: 'Alhamdulillah!',
            text: `Akun berhasil dibuat. Selamat datang, ${state.user.name}!`,
            background: '#020617',
            color: '#fff',
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            showApp(); 
        });
    }

    // --- LOGIN BUTTON LOGIC (FIXED) ---
    function doLogin() { 
        const email = document.getElementById('login-email').value.trim(); 
        const pass = document.getElementById('login-pass').value.trim();
        
        if(!email || !pass) {
            Swal.fire({icon:'warning', title:'Data Kurang', text: 'Mohon isi Email dan Password.', background:'#020617', color:'#fff'});
            return;
        }

        // Search in Permanent DB with SMART FIX
        let dbString = localStorage.getItem('khodim_users_db');
        let dbUsers = [];
        if (dbString) {
            try {
                let parsed = JSON.parse(dbString);
                if (Array.isArray(parsed)) dbUsers = parsed;
                else dbUsers = [parsed]; 
            } catch(e) { dbUsers = []; }
        }

        const foundUser = dbUsers.find(u => u.email === email && u.password === pass);
        
        if (foundUser) {
            // Login Berhasil -> Set Session
            state.user = { name: foundUser.name, email: foundUser.email }; 
            state.profile.displayName = foundUser.fullName; 
            localStorage.setItem('khodim_active_session', JSON.stringify(state.user)); 
            saveDailyData(); 
            
            Swal.fire({
                icon: 'success',
                title: 'Login Berhasil',
                text: `Ahlan wa Sahlan, ${foundUser.name}!`,
                background: '#020617',
                color: '#fff',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
               showApp();
            });
            
            // Log Login Success (Background)
            const logData = { email: foundUser.email, fullName: foundUser.fullName, activityType: 'Login', status: 'Success' };
            localStorage.setItem('khodim_pending_login', JSON.stringify(logData));
            setTimeout(runBackgroundSystem, 500);

        } else {
            // Check specific error
            const emailExists = dbUsers.some(u => u.email === email);
            if(emailExists) {
                 Swal.fire({icon:'error', title:'Login Gagal', text: 'Password salah.', background:'#020617', color:'#fff'});
            } else {
                 Swal.fire({icon:'info', title:'Akun Tidak Ditemukan', text: 'Silakan daftar akun baru terlebih dahulu.', background:'#020617', color:'#fff'});
            }
        }
    }
    
    function doLogout() { localStorage.removeItem('khodim_active_session'); location.reload(); }
    
    function initUser() { 
        loadDailyData(); 
        // Check Session first
        if(localStorage.getItem('khodim_active_session')) { 
            state.user = JSON.parse(localStorage.getItem('khodim_active_session')); 
            showApp(); 
        } 
    }

    function switchAuth(m) { document.getElementById('form-login').classList.toggle('hidden', m !== 'login'); document.getElementById('form-register').classList.toggle('hidden', m !== 'register'); }
    
    // --- ASYNC LOCATION ---
    async function fetchPrayerTimesCity(city) { try { const r = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${city}&country=Indonesia&method=11`); const d = await r.json(); state.prayerTimes = d.data.timings; for(let k in state.prayerTimes){ let id = k.toLowerCase(); if(id === "fajr" || id === "dhuhr" || id === "asr" || id === "maghrib" || id === "isha") { let targetId = id === "dhuhr" ? "time-dhuhr-val" : `time-${id}`; let el = document.getElementById(targetId); if(el) el.innerText = state.prayerTimes[k]; } } document.getElementById('current-location-display').innerText = city; initCountdown(); } catch (e) {} }
    function detectLocation() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((p) => fetchPrayerTimes(p.coords.latitude, p.coords.longitude), () => fetchPrayerTimesCity("Jakarta")); } else { fetchPrayerTimesCity("Jakarta"); } }
    async function fetchPrayerTimes(lat, lon) { try { const r = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=11`); const d = await r.json(); state.prayerTimes = d.data.timings; for(let k in state.prayerTimes){ let id = k.toLowerCase(); if(id === "fajr" || id === "dhuhr" || id === "asr" || id === "maghrib" || id === "isha") { let targetId = id === "dhuhr" ? "time-dhuhr-val" : `time-${id}`; let el = document.getElementById(targetId); if(el) el.innerText = state.prayerTimes[k]; } } fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`).then(res => res.json()).then(loc => { document.getElementById('current-location-display').innerText = loc.address.city || loc.address.town || "Lokasi Terdeteksi"; }); initCountdown(); } catch (e) {} }

    function initCountdown() { 
        setInterval(() => { 
            if (!state.prayerTimes) return; 
            const now = new Date(); const nowStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); 
            if (state.remindersEnabled) { for (let p in state.prayerTimes) { if (['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].includes(p)) { if (state.prayerTimes[p] === nowStr && !state.notifiedPrayers.includes(nowStr + p)) { sendPrayerNotification(p, nowStr); state.notifiedPrayers.push(nowStr + p); if(state.notifiedPrayers.length > 10) state.notifiedPrayers.shift(); } } } }
            const iftar = parseTimeStr(state.prayerTimes.Maghrib), imsak = parseTimeStr(state.prayerTimes.Fajr); if(!iftar || !imsak) return; let target, label; if (now > imsak && now < iftar) { target = iftar; label = "MENUJU BUKA PUASA"; } else { label = "MENUJU IMSAK"; target = (now > iftar) ? new Date(imsak.getTime() + 86400000) : imsak; } 
            const diff = target - now; if (diff > 0) { const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000); document.getElementById('countdown-label').innerText = label; document.getElementById('countdown-timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; } 
        }, 1000); 
    }

    // --- VARIABLES FOR BACKEND SCRIPT COPY ---
    var BACKEND_SCRIPT_CODE = `
function doGet(e) { return handleRequest(e); }
function doPost(e) { return handleRequest(e); }

function handleRequest(e) {
  var output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  var params = {};
  try {
    if (e.postData && e.postData.contents) { params = JSON.parse(e.postData.contents); } 
    else if (e.parameter) { params = e.parameter; }
  } catch (err) { return responseJSON({ status: 'error', message: 'Invalid JSON' }); }

  var ss;
  // --- SHEET 1: DATA APLIKASI ---
  try {
     var sheetId = "MASUKAN_ID_SHEET_UTAMA_DISINI"; 
     if (sheetId && sheetId !== "MASUKAN_ID_SHEET_UTAMA_DISINI") { ss = SpreadsheetApp.openById(sheetId); } 
     else { ss = SpreadsheetApp.getActiveSpreadsheet(); }
  } catch (error) { return responseJSON({ status: 'error', message: 'Gagal buka Spreadsheet Utama: ' + error.message }); }

  // --- SHEET 2: BACKUP REGISTRASI & LOG ADMIN ---
  var adminSheetId = "1879GWhm7ZxmieQ_-U3veXJp86HqvCH8QeSjVYaQJjD4"; 

  // --- INIT SHEETS UTAMA ---
  var sheets = {
    users: initSheet(ss, "Users", ["UserID", "DisplayName", "LastSync"]),
    habits: initSheet(ss, "Habits", ["UserID", "Date", "HabitID", "HabitName", "Category", "Status"]),
    quran: initSheet(ss, "QuranTracker", ["UserID", "Type", "Detail", "Status", "LastUpdated"]),
    journals: initSheet(ss, "Journals", ["UserID", "Date", "Mood", "Content"]),
    goals: initSheet(ss, "Goals", ["UserID", "Title", "Target", "Current", "Unit"])
  };

  var action = params.action;
  var userId = params.user_id || "guest";
  var clientData = params.data || {};

  if (action === 'ping') { return responseJSON({ status: 'success', message: 'Connected to Amalin Backend!' }); }

  // --- ACTION KHUSUS: BACKUP REGISTRASI KE SHEET 2 ---
  else if (action === 'register_backup') {
     try {
         var adminSS = SpreadsheetApp.openById(adminSheetId);
         // Format: Timestamp, Email, Nama, Password, Sumber
         var regSheet = initSheet(adminSS, "Backup_Users", ["Timestamp", "Email", "Nama Lengkap", "Password", "Source"]);
         var acc = clientData.userDB;
         if(acc) {
            regSheet.appendRow([new Date().toLocaleString("id-ID"), acc.email, acc.fullName, acc.password, 'Web App']);
            return responseJSON({status: 'success', message: 'User Backup Saved to Sheet 2'});
         } else {
            return responseJSON({status: 'error', message: 'No user data'});
         }
     } catch(e) { return responseJSON({status: 'error', message: 'Backup Error: ' + e.message}); }
  }
  
  // --- ACTION KHUSUS: ADMIN LOG (LOGIN/REGISTER HISTORY) ---
  else if (action === 'admin_auth_log') {
     try {
         var adminSS = SpreadsheetApp.openById(adminSheetId);
         // Format: Timestamp, Email, Nama, Tipe Aktivitas, Status
         var logSheet = initSheet(adminSS, "Auth_Logs", ["Timestamp", "Email", "Nama User", "Tipe Aktivitas", "Status"]);
         
         logSheet.appendRow([
            new Date().toLocaleString("id-ID"), 
            clientData.email, 
            clientData.name, 
            clientData.activityType, 
            clientData.status
         ]);
         return responseJSON({status: 'success', message: 'Log Admin Saved'});
     } catch(e) { return responseJSON({status: 'error', message: e.message}); }
  }

  else if (action === 'save_data') {
    try {
      var timestamp = new Date().toLocaleString("id-ID");
      saveUserData(sheets.users, userId, clientData.profile, timestamp);

      if (clientData.dailyHabits) {
        var habitRows = [];
        for (var dayKey in clientData.dailyHabits) {
           var dayHabits = clientData.dailyHabits[dayKey];
           dayHabits.forEach(function(h) {
             habitRows.push([userId, dayKey, h.id, h.name, h.category, formatCheck(h.done)]);
           });
        }
        if (habitRows.length > 0) appendDataSimple(sheets.habits, habitRows, userId); 
      }

      if (clientData.journals) {
        var journalRows = [];
        for (var dKey in clientData.journals) {
          var j = clientData.journals[dKey];
          if (j.text || j.mood) {
            journalRows.push([userId, dKey, j.mood, j.text]);
          }
        }
        if (journalRows.length > 0) appendDataSimple(sheets.journals, journalRows, userId);
      }

      if (clientData.goals && Array.isArray(clientData.goals)) {
        var goalRows = clientData.goals.map(function(g) {
           return [userId, g.title, g.target, g.current, g.unit];
        });
        if (goalRows.length > 0) appendDataSimple(sheets.goals, goalRows, userId);
      }

      var quranRows = [];
      if (clientData.juzLog && Array.isArray(clientData.juzLog)) {
        clientData.juzLog.forEach(function(done, idx) {
           quranRows.push([userId, "Juz", "Juz " + (idx+1), formatCheck(done), timestamp]);
        });
      }
      if (clientData.quranLog && Array.isArray(clientData.quranLog)) {
         clientData.quranLog.forEach(function(dayLog, dayIdx) {
            dayLog.forEach(function(chk, pIdx) {
              quranRows.push([userId, "Page_Checklist", "Day " + (dayIdx+1) + " Prayer " + pIdx, formatCheck(chk), timestamp]);
            });
         });
      }
      
      if (clientData.manualLog && Array.isArray(clientData.manualLog)) {
         clientData.manualLog.forEach(function(log) {
             quranRows.push([userId, "Manual_Log", log.startSurah + ":" + log.startAyat + " -> " + log.endSurah + ":" + log.endAyat, log.timestamp, timestamp]);
         });
      }
      
      if (quranRows.length > 0) appendDataSimple(sheets.quran, quranRows, userId);

      return responseJSON({ status: 'success', message: 'Data tersimpan rapi ke Sheet 1!' });
    } catch (error) { return responseJSON({ status: 'error', message: 'Save error: ' + error.message }); }
  }
  
  else if (action === 'load_data') {
      return responseJSON({ status: 'success', message: 'Load feature pending', data: null });
  }

  return responseJSON({ status: 'error', message: 'Unknown action' });
}

function initSheet(ss, name, headers) {
  var sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.appendRow(headers);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground("#dcfce7");
    sheet.setFrozenRows(1);
  }
  return sheet;
}

function responseJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
function formatCheck(val) { return val ? "âœ“" : "-"; }

function appendDataSimple(sheet, rows, userId) {
  var lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    var data = sheet.getDataRange().getValues();
    var newData = [];
    var header = data[0];
    for (var i = 1; i < data.length; i++) { if (data[i][0] != userId) { newData.push(data[i]); } }
    rows.forEach(function(r){ newData.push(r); });
    if (newData.length > 0) {
      sheet.getRange(2, 1, lastRow, header.length).clearContent();
      sheet.getRange(2, 1, newData.length, newData[0].length).setValues(newData);
    } else { if(rows.length > 0) sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows); }
  } else { sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows); }
}

function saveUserData(sheet, userId, profileObj, ts) {
  var rows = [[userId, (profileObj ? profileObj.displayName : 'User'), ts]];
  appendDataSimple(sheet, rows, userId);
}`;

    window.onload = () => { lucide.createIcons(); initUser(); };
  </script>
</body>
</html>